<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Éâ„É©„Ç¥„É≥„ÇØ„Ç®„Çπ„ÉàÈ¢®RPG</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'MS Gothic', monospace; background: #000; display: flex; justify-content: center; align-items: center; min-height: 100vh; color: #fff; }
        #game-container { width: 800px; background: #000; border: 4px solid #fff; }
        #game-screen { width: 100%; height: 480px; background: #000; position: relative; overflow: hidden; }
        #field-container { position: absolute; top: 0; left: 0; transition: transform 0.1s; }
        #field { display: grid; grid-template-columns: repeat(100, 30px); grid-template-rows: repeat(100, 30px); }
        .tile { width: 30px; height: 30px; }
        .grass { background: #0a0; }
        .forest { background: #050; }
        .water { background: #05f; }
        .mountain { background: #864; }
        .desert { background: #ed9; }
        .snow { background: #eef; }
        .swamp { background: #583; }
        .bridge { background: #963; }
        .cave { background: #333; }
        .town { background: #fa0; }
        .shop { background: #f0a; }
        #player { position: absolute; width: 30px; height: 30px; background: #ff0; border-radius: 50%; transition: all 0.1s; box-shadow: 0 0 10px rgba(255,255,0,0.5); }
        #message-box { height: 150px; background: #000; border-top: 4px solid #fff; padding: 10px; font-size: 16px; line-height: 1.3; overflow-y: auto; max-height: 200px; white-space: pre-wrap; word-wrap: break-word; }
        #status { display: flex; justify-content: space-between; padding: 10px 15px; background: #000; border-top: 2px solid #fff; font-size: 16px; }
        .status-group { display: flex; gap: 20px; }
        .battle-screen { width: 100%; height: 100%; background: #000; display: none; flex-direction: column; justify-content: space-around; align-items: center; padding: 30px; }
        /* battle-screen„ÇíÂº∑Âà∂ÁöÅEÔøΩÔøΩÈùûË°®Á§∫„Å´„Åô„Çã */
        #battle-screen.force-hide { display: none !important; }
        .enemy-group { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin: 20px 0; }
        .enemy-container { display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 10px; border: 2px solid transparent; border-radius: 5px; }
        .enemy-container.selected { border-color: #ff0; background: rgba(255, 255, 0, 0.2); }
        .enemy-container.dead { opacity: 0.3; cursor: default; }
        .enemy-sprite { font-size: 60px; }
        .enemy-number { font-size: 14px; color: #aaa; }
        .battle-info { text-align: center; font-size: 20px; min-height: 60px; }
        .battle-commands { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 400px; }
        button { padding: 8px; font-size: 18px; font-family: 'MS Gothic', monospace; background: #000; color: #fff; border: 3px solid #fff; cursor: pointer; transition: all 0.05s; }
        button:hover:not(:disabled) { background: #333; }
        button:active:not(:disabled) { transform: scale(0.95); background: #fff; color: #000; box-shadow: inset 0 0 10px rgba(255,255,255,0.5); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .msg-ally { color: #fff; }
        .msg-enemy { color: #f90; }
        @keyframes fadeOut {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }
        .battle-screen.fade-out { animation: fadeOut 2s ease-in-out forwards; }
        @keyframes screen-shake {
            0%, 100% { transform: translate(0, 0); }
            10% { transform: translate(-5px, -5px); }
            20% { transform: translate(5px, 5px); }
            30% { transform: translate(-5px, 5px); }
            40% { transform: translate(5px, -5px); }
            50% { transform: translate(-5px, 0); }
            60% { transform: translate(5px, 0); }
            70% { transform: translate(0, -5px); }
            80% { transform: translate(0, 5px); }
            90% { transform: translate(-2px, -2px); }
        }
        #game-screen.shake { animation: screen-shake 0.4s ease-in-out; }
        @keyframes enemy-shake {
            0%, 100% { transform: translateX(0); }
            10% { transform: translateX(-8px); }
            20% { transform: translateX(8px); }
            30% { transform: translateX(-8px); }
            40% { transform: translateX(8px); }
            50% { transform: translateX(-8px); }
            60% { transform: translateX(8px); }
            70% { transform: translateX(-4px); }
            80% { transform: translateX(4px); }
            90% { transform: translateX(-2px); }
        }
        .enemy-container.taking-damage { animation: enemy-shake 0.4s ease-in-out; }
        .menu { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #000; border: 4px solid #fff; padding: 30px; min-width: 500px; max-height: 80%; overflow-y: auto; z-index: 1000; }
        .menu h2, .menu h3 { margin-bottom: 20px; text-align: center; }
        #item-target-menu { display: none; }
        .target-button { display: block; width: 100%; padding: 15px; margin-bottom: 10px; background: #000; color: #fff; border: 3px solid #fff; font-size: 16px; font-family: 'MS Gothic', monospace; cursor: pointer; text-align: left; }
        .target-button:hover { background: #333; }
        .target-button.player { border-color: #ff0; }
        .target-button.companion { border-color: #0f0; }
        .shop-item, .magic-item, .equipment-item { display: flex; justify-content: space-between; padding: 10px; border: 2px solid #fff; margin-bottom: 10px; cursor: pointer; }
        .shop-item:hover, .magic-item:hover { background: #333; }
        .equipment-item { cursor: default; }
        .equipment-stat { color: #0f0; }
        .magic-item.disabled { opacity: 0.5; cursor: not-allowed; }
        .status-effect { color: #f0f; font-size: 14px; margin-top: 5px; }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="game-screen">
            <div id="field-container">
                <div id="field"></div>
            </div>
            <div id="player"></div>
            <div class="menu" id="shop-menu">
                <h2 id="shop-title">„Åø„Åõ</h2>
                <div id="shop-items"></div>
                <button onclick="game.closeShop()">Â∫ó„ÇíÂá∫„Çã</button>
            </div>
            <div class="menu" id="inn-menu">
                <h2>ÂÆøÂ±ã</h2>
                <p style="margin-bottom: 20px;">‰∏ÄÊô© 50„Ç¥„Éº„É´„Éâ„Åß„Åô„ÄÅ</p>
                <button onclick="game.stayAtInn()">„Å®„Åæ„Çã</button>
                <button onclick="game.closeInn()">ÂÆøÂ±ã„ÇíÂá∫„Çã</button>
            </div>
            <div class="menu" id="equipment-menu">
                <h2>„Åù„ÅÜ„Å≥</h2>
                <div id="equipment-list"></div>
                <button onclick="game.closeEquipmentMenu()">„ÇÇ„Å©„Çã</button>
            </div>
            <div class="menu" id="equipment-target-menu" style="display:none;">
                <h2>„Å†„Çå„Å´ „Çè„Åü„Åô</h2>
                <div id="equipment-target-list"></div>
                <button onclick="game.closeEquipmentTargetMenu()">„ÇÇ„Å©„Çã</button>
            </div>
            <div class="menu" id="field-item-menu">
                <h2>„Å©„ÅÜ„Åê</h2>
                <div id="field-item-list"></div>
                <button onclick="game.closeFieldItemMenu()">„ÇÇ„Å©„Çã</button>
            </div>
            <div class="menu" id="field-item-target-menu" style="display:none;">
                <h2>„Å†„Çå„Å´ „Å§„Åã„ÅÜ</h2>
                <div id="field-item-target-list"></div>
                <button onclick="game.closeFieldItemTargetMenu()">„ÇÇ„Å©„Çã</button>
            </div>
            <div class="battle-screen" id="battle-screen">
                <div class="enemy-group" id="enemy-group"></div>
                <div class="battle-info" id="battle-info"></div>
                <div class="menu" id="magic-menu">
                    <h3>„Åæ„Åª„ÅÜ</h3>
                    <div id="magic-list"></div>
                    <button onclick="game.closeMagicMenu()">„ÇÇ„Å©„Çã</button>
                </div>
                <div class="menu" id="item-menu">
                    <h3>„Å©„ÅÜ„Åê</h3>
                    <div id="item-list"></div>
                    <button onclick="game.closeItemMenu()">„ÇÇ„Å©„Çã</button>
                </div>
                <div class="menu" id="item-target-menu">
                    <div id="target-menu-content"></div>
                    <button onclick="game.closeItemTargetMenu()">„ÇÇ„Å©„Çã</button>
                </div>
                <div class="battle-commands" id="battle-commands">
                    <button onclick="game.attack()">„Åü„Åü„Åã„ÅÜ</button>
                    <button onclick="game.openMagicMenu()">„Åæ„Åª„ÅÜ</button>
                    <button onclick="game.openItemMenu()">„Å©„ÅÜ„Åê</button>
                    <button onclick="game.runAway()">„Å´„Åí„Çã</button>
                </div>
            </div>
        </div>
        <div id="message-box">„Çà„ÅÜ„Åì„Åù„ÄÅÂãáËÄÖ„ÅÆ‰∏ñÁïå„Å∏ÔºÅ<br>‰∏ñÁïå„ÇíÂÜíÈô∫„Åó„Çà„ÅÜÔºÅ</div>
        <div id="status">
            <div class="status-group">
                <span>ËÅ∑: <span id="job">ÂãáËÄÖ</span></span>
                <span>LV: <span id="level">1</span></span>
                <span>HP: <span id="hp">30</span>/<span id="maxHp">30</span></span>
                <span>MP: <span id="mp">10</span>/<span id="maxMp">10</span></span>
            </div>
            <div class="status-group">
                <span>EXP: <span id="exp">0</span></span>
                <span>G: <span id="gold">100</span></span>
                <button onclick="game.openEquipmentMenu()" style="padding: 5px 10px; font-size: 14px; margin-left: 20px;">„Åù„ÅÜ„Å≥</button>
                <button onclick="game.openFieldItemMenu()" style="padding: 5px 10px; font-size: 14px;">„Å©„ÅÜ„Åê</button>
                <button id="music-toggle-btn" onclick="game.toggleMusic()" style="padding: 5px 10px; font-size: 14px;">Èü≥Ê•ΩÂÅúÊ≠¢</button>
            </div>
        </div>
        <div id="field-party-status" style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:10px 0;font-size:14px;"></div>
    </div>

    <audio id="field-music" loop style="display: none;">
        <source src="„Éï„Ç°„É≥„Çø„Ç∏„Éº-Áï∞Â§â-.mp3" type="audio/mpeg">
    </audio>
    <audio id="battle-music-1" loop style="display: none;">
        <source src="RPG_Battle_03.mp3" type="audio/mpeg">
    </audio>
    <audio id="battle-music-2" loop style="display: none;">
        <source src="RPG_Battle_01.mp3" type="audio/mpeg">
    </audio>
    <audio id="battle-music-3" loop style="display: none;">
        <source src="battle.mp3" type="audio/mpeg">
    </audio>
    <audio id="shop-music" loop style="display: none;">
        <source src="„Éï„Ç°„É≥„Çø„Ç∏„Éº7-Ë°ó-.mp3" type="audio/mpeg">
    </audio>
    <audio id="enemy-attack-se" style="display: none;">
        <source src="Â∞è„Éë„É≥„ÉÅ.mp3" type="audio/mpeg">
    </audio>
    <audio id="player-attack-se" style="display: none;">
        <source src="ÊâìÊíÉ2.mp3" type="audio/mpeg">
    </audio>
    <audio id="levelup-se" style="display: none;">
        <source src="„É¨„Éô„É´„Ç¢„ÉÉ„Éó.mp3" type="audio/mpeg">
    </audio>

    <script>
        const game = {
            player: {
                name: 'ÂãáËÄÖ',
                job: 'ÂãáËÄÖ',
                x: 50, y: 50, hp: 30, maxHp: 30, mp: 10, maxMp: 10, level: 1, exp: 0, gold: 100,
                attack: 5, defense: 3, poisoned: false,
                speed: 10,
                pendingShopItem: null,
                aptitude: null,
                formation: 'front',
                equipment: {
                    weapon: null,
                    armor: null,
                    helmet: null,
                    gloves: null,
                    boots: null
                },
                inventory: {'„ÇÑ„Åè„Åù„ÅÜ': 3, '„Å©„Åè„Åë„Åó„Åù„ÅÜ': 1}
            },
            companions: [], // ‰ª≤Èñì‰∏ÄË¶ß            
            companionNames: ['Êà¶Â£´', 'È≠îÊ≥ï‰Ωø„ÅÑ', 'ÂÉß‰æ∂', 'Ë∏ä„ÇäÂ≠ê', 'ÁõóË≥ä', 'Áã©‰∫∫', 'È®éÂ£´', 'Ê≠¶ÂÖ∑ËÅ∑‰∫∫', 'ÂïÜ‰∫∫', 'ÂêüÈÅäË©©‰∫∫'],
            companionHumanNamesMale: ['Bob','Daniel','Ethan','George','Jack','Liam','Noah','Paul','Ryan','Thomas','Victor','Xavier','Zach','Aaron','Brandon','Charles','David','Edward','Frank','Henry','Ian','Jason','Kevin','Luke','Mason','Nathan','Owen','Peter','Quentin','Robert','Sean','Travis','Ulric','Vince','Walter','Yuri','Zane'],
            companionHumanNamesFemale: ['Alice','Catherine','Fiona','Hannah','Isabella','Kelly','Mia','Olivia','Quinn','Sophia','Uma','Wendy','Yvonne','Amber','Bella','Chloe','Diana','Emma','Grace','Hailey','Ivy','Jasmine','Kara','Luna','Maya','Nina','Ophelia','Piper','Renee','Sierra','Tina','Valerie','Willow','Xenia','Zoe','Serena'],
            companionHumanNamesNeutral: ['Alex','Taylor','Jordan','Skyler','Riley','Casey','Morgan','Jamie','Cameron','Rowan'],
            equipmentViewIndex: 0,
            gameOverFlag: false,
            inBattle: false,
            currentEnemies: [],
            selectedEnemyIndex: 0,
            commandsLocked: false,
            currentShop: null,
            damageHistory: {}, // „ÉÄ„É°„Éº„Ç∏Â±•Ê≠¥„ÇíË®òÈå≤: {playerName: totalDamage}
            mapSize: 100,
            viewportWidth: 16,
            viewportHeight: 16,
            map: [],
            audioContext: null,
            currentMusic: null,
            musicEnabled: true,
            inShop: false,
            battleMusicIndex: 0,
            selectedFieldMusic: null,

            enemies: [
                // ÂàùÁ¥ö„É¢„É≥„Çπ„Çø„ÉºÔºàËçâÂéü„ÄÅÊ£ÆÊûóÔºâ                
                {name:'„Çπ„É©„Ç§„É†',hp:8,attack:3,defense:1,exp:5,gold:10,sprite:'üíß',poison:false,terrain:['grass','forest'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.3}]},
                {name:'„Åì„ÅÜ„ÇÇ„Çä',hp:7,attack:4,defense:1,exp:6,gold:8,sprite:'ü¶Å',poison:false,terrain:['cave','forest'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.2}]},
                {name:'„Å®„ÅÜ„Åû„Åè',hp:16,attack:7,defense:4,exp:14,gold:20,sprite:'ü•∑',poison:false,terrain:['desert','swamp'],drops:[{item:'gold',amount:50,chance:0.2}]},
                {name:'„Åä„Åä„Å≠„Åö„Åø',hp:9,attack:3,defense:2,exp:5,gold:12,sprite:'üê≠',poison:false,terrain:['forest','cave'],drops:[{item:'„Å©„Åè„Åë„Åó„Åù„ÅÜ',chance:0.2}]},
                {name:'„Ç≥„Éú„É´„Éâ',hp:10,attack:4,defense:2,exp:7,gold:15,sprite:'üëπ',poison:false,terrain:['forest','cave'],drops:[{item:'„Å≤„ÅÆ„Åç„ÅÆ„Åº„ÅÜ',chance:0.1,type:'weapon',attack:2}]},
                {name:'„Åå„ÅÑ„Åì„Å§',hp:12,attack:5,defense:3,exp:8,gold:18,sprite:'üíÄ',poison:false,terrain:['cave','swamp'],drops:[{item:'„Åã„Çè„ÅÆ„Åº„ÅÜ„Åó',chance:0.15,type:'helmet',defense:1}]},
                {name:'„Çµ„É≥„Éâ„Éë„Éî„Éº',hp:14,attack:8,defense:2,exp:11,gold:22,sprite:'üê∂',poison:false,terrain:['desert','grass'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.15}]},
                {name:'„Çπ„Éà„Éº„É≥„Éï„Ç£„ÉÉ„Ç∑„É•',hp:20,attack:5,defense:5,exp:16,gold:28,sprite:'üêü',poison:false,terrain:['water','swamp'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.15}]},
                {name:'„Ç∞„É™„Éº„É≥„Ç≠„É£„Çø„Éî„É©„Éº',hp:15,attack:4,defense:2,exp:10,gold:18,sprite:'üêõ',poison:true,terrain:['forest','grass'],drops:[{item:'„Å©„Åè„Åë„Åó„Åù„ÅÜ',chance:0.25}]},
                {name:'„ÉÄ„Çπ„Éà„Ç¶„É´„Éï',hp:22,attack:8,defense:3,exp:8,gold:20,sprite:'üê∫',poison:false,terrain:['desert','grass'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.2}]},
                {name:'„Éë„Éï„Éì„Éº',hp:17,attack:4,defense:2,exp:2,gold:20,sprite:'ü™∞',poison:false,terrain:['grass','flower'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.15}]},
                {name:'„Éà„Éº„Éâ„É°„Ç§„Ç∏',hp:24,attack:12,defense:3,exp:10,gold:42,sprite:'üê∏',poison:false,terrain:['swamp','forest'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.25}]},
                {name:'„Çπ„Éà„Éº„É≥„É©„Éì„ÉÉ„Éà',hp:18,attack:6,defense:8,exp:15,gold:28,sprite:'üêá',poison:false,terrain:['mountain','grass'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.15}]},
                {name:'„Ç§„É≥„Éó„ÇΩ„É´„Ç∏„É£„Éº',hp:20,attack:7,defense:3,exp:18,gold:36,sprite:'',poison:false,terrain:['cave','swamp'],drops:[{item:'„Å©„Åè„Åë„Åó„Åù„ÅÜ',chance:0.2}]},
                {name:'„Ç∞„É¨„Ç§„Ç¥„Éñ„É™„É≥',hp:22,attack:8,defense:4,exp:19,gold:38,sprite:'üë∫',poison:false,terrain:['cave','forest'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.2}]},
                
                // ‰∏≠Á¥ö„É¢„É≥„Çπ„Çø„ÉºÔøΩEÔøΩEesert, swamp, caveÔøΩEÔøΩE                
                {name:'„Ç¥„Éñ„É™„É≥',hp:15,attack:6,defense:2,exp:12,gold:25,sprite:'üë∫',poison:false,terrain:['forest','cave'],drops:[{item:'„Å©„ÅÜ„ÅÆ„Å§„Çã„Åé',chance:0.1,type:'weapon',attack:5}]},
                {name:'„Ç¥„Éº„Çπ„Éà',hp:13,attack:7,defense:3,exp:13,gold:28,sprite:'üëª',poison:false,terrain:['cave','swamp'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.25}]},
                {name:'„Çø„Ç§„Ç¨„Éº',hp:18,attack:8,defense:2,exp:15,gold:30,sprite:'üêØ',poison:false,terrain:['forest','desert'],drops:[{item:'„Å°„Åã„Çâ„ÅÆ„Åü„Å≠',chance:0.15}]},
                {name:'„Åå„ÅÑ„Åì„Å§Êà¶Â£´',hp:20,attack:9,defense:5,exp:16,gold:32,sprite:'‚öîÔ∏Å',poison:false,terrain:['cave','swamp'],drops:[{item:'„Å¶„Å§„ÅÆ„Åã„Å∂„Å®',chance:0.12,type:'helmet',defense:3}]},
                {name:'„Çæ„É≥„Éì',hp:22,attack:8,defense:3,exp:15,gold:28,sprite:'üßÅ',poison:true,terrain:['swamp','cave'],drops:[{item:'„Å©„Åè„Åë„Åó„Åù„ÅÜ',chance:0.3}]},
                {name:'„Åä„Åä„Åï„Åù„Çä',hp:20,attack:9,defense:4,exp:17,gold:35,sprite:'ü¶Å',poison:true,terrain:['desert','swamp'],drops:[{item:'„Å©„Åè„Åë„Åó„Åù„ÅÜ',chance:0.4}]},
                {name:'„ÉØ„Ç§„É´„Éâ„Åπ„Ç¢„Éº',hp:25,attack:11,defense:3,exp:18,gold:40,sprite:'üêª',poison:false,terrain:['forest','snow'],drops:[{item:'„Å°„Åã„Çâ„ÅÆ„Åü„Å≠',chance:0.2}]},
                {name:'„Ç≠„É©„Éº„Éì„Éº',hp:14,attack:8,defense:2,exp:14,gold:28,sprite:'üêù',poison:false,terrain:['forest','flower'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.3}]},
                {name:'„Åä„Åä„Åì„ÅÜ„ÇÇ„Çä',hp:17,attack:9,defense:2,exp:16,gold:32,sprite:'ü¶Å',poison:false,terrain:['cave','mountain'],drops:[{item:'„Å°„Åã„Çâ„ÅÆ„Åü„Å≠',chance:0.2}]},
                {name:'„Çπ„Éó„É©„Ç§„Éà',hp:15,attack:10,defense:2,exp:17,gold:38,sprite:'‚ú®',poison:false,terrain:['forest','snow'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.35}]},
                {name:'„Ç™„Éº„Ç¨',hp:24,attack:10,defense:3,exp:19,gold:42,sprite:'üëπ',poison:false,terrain:['cave','swamp'],drops:[{item:'„Å©„ÅÜ„ÅÆ„Å§„Çã„Åé',chance:0.15,type:'weapon',attack:7}]},
                {name:'„Ç¥„Éñ„É™„É≥„É°„Ç§„Ç∏',hp:18,attack:6,defense:5,exp:16,gold:25,sprite:'üëπ',poison:false,terrain:['forest','grass'],drops:[{item:'„Å©„ÅÜ„ÅÆ„Å§„Çã„Åé',chance:0.15,type:'weapon',attack:7}]},
                {name:'„ÉØ„Ç§„É´„Éâ„Éï„Ç©„ÉÉ„ÇØ„Çπ',hp:18,attack:11,defense:3,exp:15,gold:30,sprite:'ü¶Å',poison:false,terrain:['forest','grass'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.2}]},
                {name:'„Çπ„Éà„Éº„É≥„Ç∏„É£',hp:24,attack:12,defense:6,exp:20,gold:40,sprite:'ü™®',poison:false,terrain:['mountain','cave'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.2}]},
                {name:'„Éë„Éï„Ç£„Éº„ÇØ„É©„Ç≤',hp:16,attack:9,defense:2,exp:12,gold:22,sprite:'ü™º',poison:false,terrain:['water'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.2}]},
                {name:'„Åï„Åæ„Çà„ÅÑ„Éä„Ç§„Éà',hp:28,attack:10,defense:6,exp:24,gold:45,sprite:'üõ°',poison:false,terrain:['cave','swamp'],drops:[{item:'„Å©„ÅÜ„ÅÆ„Å§„Çã„Åé',chance:0.2,type:'weapon',attack:6}]},
                {name:'„Éñ„É©„Ç¶„É≥„Ç™„Éº„ÇØ',hp:26,attack:12,defense:5,exp:22,gold:44,sprite:'üêó',poison:false,terrain:['forest','grass'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.2}]},
                {name:'„Çπ„Éî„É≥„Éì„Éº',hp:14,attack:11,defense:2,exp:10,gold:18,sprite:'üêù',poison:true,terrain:['flower','forest'],drops:[{item:'„Å©„Åè„Åë„Åó„Åù„ÅÜ',chance:0.25}]},
                {name:'„É©„É≥„Çø„É≥„É¢„Çπ',hp:18,attack:8,defense:8,exp:14,gold:24,sprite:'ü¶Å',poison:false,terrain:['forest','swamp'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.2}]},
                {name:'„Ç∞„É©„Çπ„Çπ„Éç„Éº„ÇØ',hp:17,attack:9,defense:4,exp:12,gold:22,sprite:'üêç',poison:true,terrain:['grass','forest'],drops:[{item:'„Å©„Åè„Åë„Åó„Åù„ÅÜ',chance:0.25}]},
                {name:'„É°„Çø„É´„Éë„Éî„Éº',hp:15,attack:9,defense:12,exp:24,gold:50,sprite:'üê∂',poison:false,terrain:['mountain','grass'],drops:[{item:'„Å¶„Å§„ÅÆ„Åã„Å∂„Å®',chance:0.15,type:'helmet',defense:3}]},

                // ‰∏äÁ¥ö„É¢„É≥„Çπ„Çø„ÉºÔøΩEÔøΩEave, mountainÔøΩEÔøΩE                {name:'„Ç¥„Éº„É¨„É†',hp:35,attack:9,defense:10,exp:26,gold:60,sprite:'üóø',poison:false,terrain:['cave','mountain'],drops:[{item:'„Å¶„Å§„ÅÆ„Åã„Å∂„Å®',chance:0.2,type:'helmet',defense:4}]},
                {name:'„Ç≠„É©„Éº„Éä„Ç§„Éà',hp:30,attack:14,defense:7,exp:28,gold:65,sprite:'üõ°',poison:false,terrain:['cave'],drops:[{item:'„ÅØ„Åå„Å≠„ÅÆ„Å§„Çã„Åé',chance:0.12,type:'weapon',attack:10}]},
                {name:'È≠îË°ìÂ∏´',hp:22,attack:13,defense:4,exp:27,gold:55,sprite:'üßÅ',poison:false,terrain:['cave','swamp'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.4}]},
                {name:'ÈáéÊ≠¶Â£´',hp:26,attack:12,defense:6,exp:25,gold:58,sprite:'ü•æ',poison:false,terrain:['desert','swamp'],drops:[{item:'gold',amount:100,chance:0.25}]},
                {name:'Ê£Æ„ÅÆÈ≠îÂ•≥',hp:23,attack:14,defense:4,exp:29,gold:62,sprite:'üëµ',poison:false,terrain:['forest'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.5}]},
                {name:'„Ç¥„Éñ„É™„É≥„É≠„Éº„Éâ',hp:32,attack:15,defense:5,exp:30,gold:70,sprite:'üëπ',poison:false,terrain:['cave'],drops:[{item:'„Åª„ÅÆ„Åä„ÅÆ„Å§„Çã„Åé',chance:0.1,type:'weapon',attack:15}]},
                {name:'„Ç™„Éº„Ç¨„É≠„Éº„Éâ',hp:40,attack:16,defense:6,exp:35,gold:85,sprite:'üëπ',poison:false,terrain:['cave'],drops:[{item:'„Åª„ÅÆ„Åä„ÅÆ„Å§„Çã„Åé',chance:0.12,type:'weapon',attack:20}]},
                {name:'„Éñ„É©„ÉÅ„Éä„Éä„Ç§„Éà',hp:38,attack:17,defense:8,exp:38,gold:95,sprite:'üñ§',poison:false,terrain:['cave'],drops:[{item:'„Åª„ÅÆ„Åä„ÅÆ„Å§„Çã„Åé',chance:0.15,type:'weapon',attack:20}]},
                
                {name:'„Éñ„É©„ÉÉ„ÇØ„Ç¥„Éñ„É™„É≥',hp:24,attack:12,defense:4,exp:20,gold:45,sprite:'ü©∏',poison:false,terrain:['forest','swamp'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.25}]},
                {name:'„Ç™„Éº„ÇØ„ÇΩ„Éº„Éâ„Éû„É≥',hp:28,attack:13,defense:5,exp:22,gold:48,sprite:'üó°',poison:false,terrain:['forest','cave'],drops:[{item:'„Å©„ÅÜ„ÅÆ„Å§„Çã„Åé',chance:0.15,type:'weapon',attack:6}]},
                {name:'„Ç∏„É£„É≥„Ç∞„É´„Ç≤„É™„É•„Ç™„É≥',hp:34,attack:14,defense:6,exp:28,gold:60,sprite:'üêÜ',poison:false,terrain:['forest','swamp'],drops:[{item:'„Å°„Åã„Çâ„ÅÆ„Åü„Å≠',chance:0.2}]},
                {name:'„Çπ„Éà„Éº„É≥„Ç¥„Éº„É¨„É†',hp:42,attack:12,defense:12,exp:32,gold:75,sprite:'ü™®',poison:false,terrain:['mountain','cave'],drops:[{item:'„Å¶„Å§„ÅÆ„Åã„Å∂„Å®',chance:0.2,type:'helmet',defense:3}]},
                {name:'„Åó„Å´„Åå„ÅøÂÖµ',hp:30,attack:15,defense:6,exp:26,gold:65,sprite:'üíÄ',poison:false,terrain:['cave','swamp'],drops:[{item:'„Å©„Åè„Åë„Åó„Åù„ÅÜ',chance:0.25}]},
                {name:'„Ç∑„É£„Éâ„Ç¶„Ç≥„Éû„É≥„ÉÄ„Éº',hp:36,attack:17,defense:7,exp:34,gold:80,sprite:'üó°',poison:false,terrain:['cave','desert'],drops:[{item:'„ÅØ„Åå„Å≠„ÅÆ„Å§„Çã„Åé',chance:0.15,type:'weapon',attack:10}]},
                {name:'„Ç≥„Éº„É´„Éâ„É™„Ç∂„Éº„Éâ',hp:28,attack:12,defense:5,exp:22,gold:52,sprite:'ü¶Å',poison:false,terrain:['snow','mountain'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.2}]},
                {name:'„Éï„Ç°„Ç§„Ç¢„É™„Ç∂„Éº„Éâ',hp:26,attack:14,defense:4,exp:24,gold:55,sprite:'üî•',poison:false,terrain:['desert','cave'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.2}]},
                {name:'„Éñ„É´„Éº„Éõ„Éº„Éç„ÉÉ„Éà',hp:20,attack:13,defense:3,exp:19,gold:40,sprite:'üêù',poison:true,terrain:['forest','flower'],drops:[{item:'„Å©„Åè„Åë„Åó„Åù„ÅÜ',chance:0.3}]},
                {name:'„Çµ„Éº„Éö„É≥„Éà„Éä„Ç§„Éà',hp:34,attack:15,defense:6,exp:30,gold:70,sprite:'üêç',poison:true,terrain:['swamp','water'],drops:[{item:'„Å°„Åã„Çâ„ÅÆ„Åü„Å≠',chance:0.2}]},
                {name:'„Çπ„Ç≥„Éº„Éî„Ç™„É≥',hp:32,attack:17,defense:5,exp:32,gold:75,sprite:'ü¶Å',poison:true,terrain:['desert','cave'],drops:[{item:'„Å©„Åè„Åë„Åó„Åù„ÅÜ',chance:0.4}]},
                {name:'„Éü„Çπ„Éà„Éü„Éé„Çø„Ç¶„É≠„Çπ',hp:44,attack:18,defense:9,exp:40,gold:90,sprite:'üêÇ',poison:false,terrain:['swamp','mountain'],drops:[{item:'„ÅØ„Åå„Å≠„ÅÆ„Å§„Çã„Åé',chance:0.18,type:'weapon',attack:10}]},
                {name:'„Ç¢„Ç§„Ç¢„É≥„Ç¨„Éº„Ç¥„Ç§„É´',hp:30,attack:14,defense:10,exp:30,gold:70,sprite:'üóø',poison:false,terrain:['mountain','cave'],drops:[{item:'„Å¶„Å§„ÅÆ„Åã„Å∂„Å®',chance:0.2,type:'helmet',defense:3}]},
                {name:'„ÇΩ„Ç¶„É´„É¨„É≥„Ç∏„É£„Éº',hp:26,attack:13,defense:5,exp:24,gold:55,sprite:'üèπ',poison:false,terrain:['forest','swamp'],drops:[{item:'„Ç∑„Éß„Éº„Éà„Éú„Ç¶',chance:0.15,type:'weapon',attack:4,ranged:true}]},
                {name:'„Çπ„Éî„Ç¢„É©„Éì„ÉÉ„Éà',hp:18,attack:10,defense:3,exp:14,gold:30,sprite:'üê≠',poison:false,terrain:['grass','forest'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.2}]},
                {name:'„Éï„Ç£„Éº„É´„Éâ„Éê„ÉÉ„Éà',hp:16,attack:9,defense:2,exp:12,gold:25,sprite:'ü¶Å',poison:false,terrain:['grass','cave'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.15}]},
                {name:'„Éì„Éº„Éà„É´„Éï„Ç°„Ç§„Çø„Éº',hp:25,attack:12,defense:6,exp:22,gold:44,sprite:'ü™≤',poison:false,terrain:['forest','mountain'],drops:[{item:'„Å°„Åã„Çâ„ÅÆ„Åü„Å≠',chance:0.2}]},
                {name:'„Éû„ÉÉ„Éâ„É¢„Éº„É´',hp:20,attack:10,defense:4,exp:16,gold:30,sprite:'üêæ',poison:false,terrain:['swamp','grass'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.2}]},
                {name:'„Çπ„Éî„É™„ÉÉ„Éà',hp:23,attack:11,defense:5,exp:21,gold:40,sprite:'üå≤',poison:false,terrain:['forest'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.25}]},
                {name:'„Éï„Ç°„É≥„Ç∞„Éõ„Éº„ÇØ',hp:20,attack:13,defense:3,exp:20,gold:38,sprite:'ü™∂',poison:false,terrain:['mountain','grass'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.2}]},
                {name:'„Çµ„Éú„ÉÜ„É≥„Éï„Ç°„Ç§„Çø„Éº',hp:24,attack:12,defense:4,exp:20,gold:36,sprite:'üåµ',poison:true,terrain:['desert'],drops:[{item:'„Å©„Åè„Åë„Åó„Åù„ÅÜ',chance:0.3}]},
                {name:'„Éú„Éº„É≥„ÉÅ„ÉÉ„ÇØ',hp:18,attack:9,defense:3,exp:14,gold:26,sprite:'üê§',poison:false,terrain:['cave','grass'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.2}]},
                {name:'„Ç¶„Ç©„Éº„Çø„Éº„Çπ„Éç„Ç§„É´',hp:26,attack:11,defense:6,exp:22,gold:40,sprite:'üêå',poison:false,terrain:['water','swamp'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.2}]},
                {name:'„Éê„Ç§„Çø„É´„Éû„ÉÉ„Ç∑„É•',hp:20,attack:10,defense:3,exp:16,gold:28,sprite:'üçÑ',poison:false,terrain:['forest','swamp'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.25}]},
                {name:'„Éñ„ÉÉ„Ç∑„É•„Éê„Éº„Éâ',hp:19,attack:9,defense:3,exp:15,gold:26,sprite:'üê¶',poison:false,terrain:['grass','forest'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.15}]},
                {name:'„É¨„Éº„Çπ„Éë„Ç§„ÇØ',hp:21,attack:12,defense:4,exp:18,gold:34,sprite:'ü™∏',poison:false,terrain:['water','desert'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.2}]},
                {name:'„Éé„É≠„Ç§„Éí„É´„Éâ„ÉÉ„Ç∞',hp:24,attack:13,defense:4,exp:21,gold:38,sprite:'üêï',poison:true,terrain:['swamp','grass'],drops:[{item:'„Å©„Åè„Åë„Åó„Åù„ÅÜ',chance:0.25}]},
                {name:'„Çπ„Ç±„Ç§„É´„Éï„Ç°„É≥„Ç∞',hp:26,attack:14,defense:5,exp:24,gold:46,sprite:'üêâ',poison:false,terrain:['mountain','cave'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.2}]},
                {name:'„Ç¢„Ç§„Ç¢„É≥„Éì„Éº„Éà„É´',hp:30,attack:13,defense:8,exp:26,gold:50,sprite:'ü™≤',poison:false,terrain:['forest','mountain'],drops:[{item:'„Å¶„Å§„ÅÆ„Åã„Å∂„Å®',chance:0.15,type:'helmet',defense:3}]},
                {name:'„Çπ„É¢„Éº„É´„Ç¢„É≥„Éà',hp:18,attack:8,defense:2,exp:12,gold:22,sprite:'üêú',poison:true,terrain:['swamp','desert'],drops:[{item:'„Å©„Åè„Åë„Åó„Åù„ÅÜ',chance:0.3}]},
                {name:'„Çπ„ÉØ„É≥„Éó„Éï„É≠„ÉÉ„Ç∞',hp:20,attack:9,defense:3,exp:14,gold:24,sprite:'üê∏',poison:false,terrain:['swamp'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.2}]},
                {name:'„Ç´„É©„Çπ„Ç¶„Ç©„É™„Ç¢',hp:22,attack:12,defense:4,exp:18,gold:34,sprite:'üê¶',poison:false,terrain:['grass','forest'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.2}]},
                {name:'„É¨„Éº„Éê„Ç§„Éë„Éº',hp:19,attack:11,defense:3,exp:15,gold:28,sprite:'üêç',poison:true,terrain:['grass','swamp'],drops:[{item:'„Å©„Åè„Åë„Åó„Åù„ÅÜ',chance:0.25}]},
                {name:'„Ç∑„É£„Éâ„Ç¶„É©„Éì„ÉÉ„Éà',hp:17,attack:10,defense:3,exp:14,gold:26,sprite:'üêÄ',poison:false,terrain:['cave','swamp'],drops:[{item:'„ÇÑ„Åè„Åù„ÅÜ',chance:0.15}]},
            ],

            npcs: [
                {
                    name: 'ÂÜíÈô∫ËÄÖ', sprite: '',
                    messages: [
                        'Ê£Æ„Å´„ÅØ„É¢„É≥„Çπ„Çø„Éº„ÅåÂ§ö„ÅÑ„Åå„ÄÅÁµåÈ®ìÂÄ§Á®º„Åé„Å´„ÅØ„ÇÇ„Å£„Å¶„Åì„ÅÑ„Å†„ÅúÔºÅ',
                        '„ÅäÂâç„ÇÇÈ†ëÂºµ„Å£„Å¶„Å™„ÄÇ',
                        'Âº∑„ÅÑÊïµ„ÇíÂÄí„Åô„ÅÆ„ÅØÊ∞óÊåÅ„Å°„ÅÑ„ÅÑ„Åû„ÄÇ',
                        '„Åì„ÅÆ‰ªï‰∫ã„ÅØËæõ„ÅÑ„Åå„ÄÅ„ÇÑ„Çä„Åå„ÅÑ„Åå„ÅÇ„Çã„ÄÇ',
                        '„Å©„Åì„Å´Âêë„Åã„Å£„Å¶„Çã„Çì„Å†Ôºü',
                        'Ë£ÖÂÇô„Çí„Åó„Å£„Åã„ÇäÊï¥„Åà„Çã„Çì„Å†„Åû„ÄÇ',
                        'ÁµåÈ®ìÂÄ§„ÅØÂòò„Çí„Å§„Åã„Å™„ÅÑ„ÄÇ',
                        'Ê≠ª„Å¨„Å™„Çà„ÄÇÊú¨Ê∞ó„Åß„Å™„ÄÇ',
                        '„ÅÑ„ÅÑ‰ª≤Èñì„Åå„ÅÑ„Çã„Å®Âº∑„Åè„Å™„Çå„Çã„ÄÇ',
                        'Êïµ„ÅÆÂº±ÁÇπ„ÇíË¶ã„Å§„Åë„Çã„ÅÆ„ÅåÂ§ß‰∫ã„Å†„ÄÇ',
                        'ÊØéÊó•„ÅåÂÜíÈô∫„Å†„Åú„ÄÇ',
                        'ÂæåÊÇî„ÅÆ„Å™„ÅÑ‰∫∫Áîü„ÇíÊ≠©„ÇÇ„ÅÜ„Åú„ÄÇ',
                        'Â§±Êïó„Å™„Çì„Å¶Ë™∞„Å´„Åß„ÇÇ„ÅÇ„Çã„Çì„Å†„ÄÇ',
                        'Âêõ„ÅÆÁõÆ„ÄÅËºù„ÅÑ„Å¶„Çã„Å™„ÄÇ'
                    ]
                },
                {
                    name: 'È≠îÊ≥ï‰Ωø„ÅÑ', sprite: '‚ú®',
                    messages: [
                        'È≠îÊ≥ï„ÅØÊïµ„Ç∞„É´„Éº„Éó„Å´Â§ß„Åç„Å™„ÉÄ„É°„Éº„Ç∏„Çí‰∏é„Åà„Çâ„Çå„Çã„Åû„ÄÇ',
                        'È≠îÊ≥ï„ÅÆ‰øÆË°å„Å´ÁµÇ„Çè„Çä„ÅØ„Å™„ÅÑ„ÄÇ',
                        'Ëá™ÁÑ∂„ÅÆÂäõ„ÇíÂÄü„Çä„Çã„ÅÆ„ÅåÈ≠îÊ≥ï„Å†„ÄÇ',
                        '„Åì„ÅÆÂäõ„ÅØÂç±Èô∫„Åß„ÇÇ„ÅÇ„Çã„ÄÇ',
                        '„ÇÇ„Å£„Å®‰øÆË°å„ÇíÁ©ç„ÇÄ„Çì„Å†„ÄÇ',
                        'È≠îÂäõ„ÇíÊÑü„Åò„Çã„ÅãÔºÅ',
                        'Âë™Êñá„ÅØÊ≠£Á¢∫„Å´Âî±„Åà„Çã„Çì„Å†„ÄÇ',
                        'È≠îÊ≥ï„ÅØÂ•ΩÂ•áÂøÉ„Å®‰ø°Âøµ„Å†„ÄÇ',
                        'Â±ûÊÄß„ÇíÁêÜËß£„Åô„Çã„Åì„Å®„ÅåÂ§ß‰∫ã„Å†„ÄÇ',
                        'È≠îÊ≥ï„ÇíÁîò„ÅèË¶ã„Çã„Çì„Åò„ÇÉ„Å™„ÅÑ„Åû„ÄÇ',
                        '‰øÆË°å„ÅåË∂≥„Çä„Å™„ÅÑ„Å™„ÇâÈçõ„Åà„Çç„ÄÇ',
                        'Âäõ„ÇíÊ±Ç„ÇÅ„Çã„Å™„ÄÇÁü•Ë≠ò„ÇíÊ±Ç„ÇÅ„Çç„ÄÇ',
                        'È≠îÊ≥ï„Åß‰∫∫„ÇíÂä©„Åë„Çã„Åì„Å®„ÅåÊú¨Êù•„ÅÆÂßø„Å†„ÄÇ',
                        'Âêõ„Å´„ÇÇÈ≠îÊ≥ï„ÅÆÊâçËÉΩ„Åå„ÅÇ„Çã„Åã„ÇÇ„Åó„Çå„Å™„ÅÑ„Å™„ÄÇ'
                    ]
                },
                {
                    name: 'Ê≠¶Âô®ÂïÜ‰∫∫', sprite: 'üõ°',
                    messages: [
                        'ËâØ„ÅÑÊ≠¶Âô®„ÇíÊâã„Å´ÂÖ•„Çå„Çå„Å∞Âº∑Êïµ„Å´„ÇÇÂãù„Å¶„Çã„ÅØ„Åö„Å†„ÄÇ',
                        'ÊúÄÈ´ò„ÅÆÊ≠¶Âô®„Çí‰Ωú„Çã„Åü„ÇÅ„Å´‰∫∫Áîü„ÇíË≤ª„ÇÑ„Åó„Åü„ÄÇ',
                        'Ë≥™„ÅÆËâØ„ÅÑÊ≠¶Âô®„ÅØÂÄ§„ÅåÂºµ„Çã„ÇÇ„ÅÆ„Å†„ÄÇ',
                        'Âêõ„ÅÆÊ≠¶Âô®„ÅØ„Åæ„Å†„Åæ„Å†„Å†„Å™„ÄÇ',
                        'Ê≠¶Âô®„ÅØÊâ±„ÅÑÊñπ„ÅåÂ§ß‰∫ã„Å™„Çì„Å†„ÄÇ',
                        'ËâØ„ÅÑÊ≠¶Âô®„ÅØËâØ„ÅÑÁ¥†Êùê„Åã„ÇâÁîü„Åæ„Çå„Çã„Çì„Å†„ÄÇ',
                        'Ââ£„ÇíÁ£®„Åè„Å®„ÅÑ„ÅÜ„ÅÆ„ÅØÂøÉ„ÇíÁ£®„Åè„Åì„Å®„Åß„ÇÇ„ÅÇ„Çã„Çì„Å†„ÄÇ',
                        'Èáë„Çí„Ç±„ÉÅ„Çã„Å™„ÄÇÂëΩ„Åå„Åã„Åã„Å£„Å¶„Çã„Çì„Å†„ÄÇ',
                        '„Åì„ÅÆ„Çª„Éº„É´ÂìÅ„ÄÅÊú¨ÂΩì„Å´„ÅäË≤∑„ÅÑÂæó„Å†„Åú„ÄÇ',
                        'Âº∑Êïµ„Å´„ÅØÂº∑„ÅÑÊ≠¶Âô®„ÅåÂøÖË¶Å„Å†„ÄÇ',
                        '‰∏ÄÊµÅ„ÅÆÊ≠¶Âô®„ÅØÊà¶„ÅÑÊñπ„ÇÇÂ§â„Åà„Çã„Çì„Å†„ÄÇ',
                        'Ê≠¶Âô®„Å´ÂêçÂâç„Çí„Å§„Åë„Çã„Å®„ÅÑ„ÅÑ„Åû„ÄÇ',
                        'ÊâãÂÖ•„Çå„ÇíÊÄ†„Çã„Å™„Çà„ÄÇ',
                        'Ê≠¶Âô®„ÅØÈÅìÂÖ∑„Å†„Åå„ÄÅÁõ∏Ê£í„Åß„ÇÇ„ÅÇ„Çã„Çì„Å†„ÄÇ'
                    ]
                },
                {
                    name: 'Ë∏ä„ÇäÂ≠ê', sprite: 'üíÉ',
                    messages: [
                        'Âº∑„Åè„Å™„Çã„Å´„ÅØÁµåÈ®ì„ÇíÁ©ç„ÇÄ„Åì„Å®„ÅåÂ§ß‰∫ã„Çà„ÄÇ',
                        'ÊØéÊô©„Åì„Åì„ÅßË∏ä„Å£„Å¶„Çã„Çì„Å†„ÄÇ',
                        'Âêõ„ÇÇË∏ä„Å£„Å¶„Åø„Åü„ÇâÔºü',
                        '‰Ωì„ÇíÂãï„Åã„Åô„Å®Ê∞óÊåÅ„Å°„ÅÑ„ÅÑ„ÅÆ„ÄÇ',
                        'Èü≥Ê•Ω„Å´Âêà„Çè„Åõ„Å¶Âãï„Åè„ÅÆ„ÅØÊúÄÈ´ò„Çà„ÄÇ',
                        'Ë∏ä„Çä„ÅØÊà¶„ÅÑ„Å®Âêå„Åò„Çà„ÄÇ„É™„Ç∫„É†„ÅåÂ§ß‰∫ã„ÄÇ',
                        'Â§±Êïó„Åó„Å¶„ÇÇÁ´ã„Å°‰∏ä„Åå„Çã„Çì„Å†„ÄÇ',
                        'ÂøÉ„ÇíËªΩ„Åè„Åó„Å¶„Åø„Åü„ÇâÔºü',
                        'ÊØéÊó•„ÅåÊñ∞„Åó„ÅÑËàûÂè∞„Çà„ÄÇ',
                        'Âêõ„ÅÆÂãï„Åç„Å´Âã¢„ÅÑ„Åå„ÅÇ„Çã„Å≠„ÄÇ',
                        '„ÇÇ„Å£„Å®Ëá™ÂàÜ„Çí‰ø°„Åò„Å¶„ÄÇ',
                        'Ë∏ä„Çã„Çà„ÅÜ„Å´Áîü„Åç„Çã„ÅÆ„Çà„ÄÇ',
                        '„Å§„Çâ„ÅÑÊôÇ„ÇÇ‰Ωì„ÇíÂãï„Åã„Åô„Å®„ÅÑ„ÅÑ„Çè„ÄÇ',
                        'Âêõ„Å´„ÇÇË∏ä„Çä„ÅÆÈÅ©ÊÄß„Åå„ÅÇ„Çã„Åã„ÇÇ„Å≠„ÄÇ'
                    ]
                },
                {
                    name: 'ÂÉß‰æ∂', sprite: '‚õ™',
                    messages: [
                        '„Åì„ÅÆ„ÅÇ„Åü„Çä„ÅØËÅñ„Å™„ÇãÂúüÂú∞„Å®„Åï„Çå„Å¶„ÅÑ„Çã„Çì„Å†„ÄÇ',
                        'Á•û„ÅÆÂä†Ë≠∑„Åå„ÅÇ„Çä„Åæ„Åô„Çà„ÅÜ„Å´„ÄÇ',
                        '‰ø°‰ª∞„ÅØÂøÉ„ÅÆÊîØ„Åà„Å†„ÄÇ',
                        'Á•à„Çã„Åì„Å®„ÅßÂøÉ„ÅØËêΩ„Å°ÁùÄ„Åè„ÄÇ',
                        '„Åì„ÅÆ‰∏ñÁïå„ÅÆÁßòÂØÜ„ÇíÁü•„Çä„Åü„Åè„Å¶„Å≠„ÄÇ',
                        'Ëø∑„Å£„ÅüÊôÇ„ÅØÁ•à„Çã„Çì„Å†„ÄÇ',
                        'Á•û„ÅØË¶ãÂÆà„Å£„Å¶„Åè„Å†„Åï„Å£„Å¶„ÅÑ„Çã„ÄÇ',
                        'ÁΩ™„ÇíÊÇî„ÅÑÊîπ„ÇÅ„Çã„Åì„Å®„ÅßÂøÉ„ÅØÊïë„Çè„Çå„Çã„ÄÇ',
                        '„Å©„Çì„Å™ÊôÇ„ÇÇÂ∏åÊúõ„ÇíÂøò„Çå„Çã„Å™„ÄÇ',
                        'ÊØéÊó•Á•à„Çã„Åì„Å®„ÅåÂ§ß‰∫ã„Å™„Çì„Å†„ÄÇ',
                        '‰∫∫„ÇíÂä©„Åë„Çã„Åì„Å®„ÅåÁ•û„ÅÆÊïô„Åà„Å†„ÄÇ',
                        'Âõ∞„Å£„ÅüÊôÇ„ÅØÈ†º„Å£„Å¶„ÅÑ„ÅÑ„Çì„Å†„ÄÇ',
                        'È≠Ç„ÅÆÊïëÊ∏à„ÅåÁßÅ„Åü„Å°„ÅÆÂΩπÁõÆ„Å†„ÄÇ',
                        'Âêõ„ÅØÂøÉ„ÅåÊ∏Ö„Çâ„Åã„Å™„Çà„ÅÜ„Å†„Å≠„ÄÇ'
                    ]
                },
                {
                    name: 'ÁõóË≥ä', sprite: 'ü•∑',
                    messages: [
                        'Èáë„Å™„Çâ„Åì„Åì„Çâ„Åß„Åü„Å£„Å∑„ÇäÁ®º„Åí„Çã„Åú„ÄÇ',
                        'Êòî„ÅÆ‰ø∫„ÅØÊú¨ÂΩì„Å´ÊÇ™ÂÖö„Å†„Å£„Åü„ÄÇ',
                        '„Åù„Çå„Åß„ÇÇÁîü„ÅçÊñπ„ÇíÂ§â„Åà„Åü„Çì„Å†„ÄÇ',
                        '„ÅäÂâç„ÇÇÂ∞ë„ÅóÈÅì„ÇíÂ§ñ„Çå„Çã„Å®Ê•Ω„Åó„ÅÑ„ÅúÔºü',
                        '„Åì„ÅÆ‰∏ñÁïå„ÅØÂº±ËÇâÂº∑È£ü„Å†„ÄÇ',
                        'Âç±Èô∫„ÇíÂÜí„Åó„Å¶Áîü„Åç„Å¶„Çã‰ªä„ÅåÊú¨ÂΩì„Å†„ÄÇ',
                        '„Çπ„Éî„Éº„Éâ„Å®Âãï„Åç„ÅåÂ§ß‰∫ã„Å™„Çì„Å†„ÄÇ',
                        'ÂΩ±„Å´Èö†„Çå„Çã„Çπ„Ç≠„É´„ÇíÂ≠¶„Å∂„Å®„ÅÑ„ÅÑ„ÄÇ',
                        'Á§æ‰ºö„ÅÆË£èÂÅ¥„ÅØÊú¨ÂΩì„Å´ÊÄñ„ÅÑ„Åû„ÄÇ',
                        '‰ø°È†º„ÅØ‰Ωï„Çà„ÇäÂ§ß‰∫ã„Å†„ÄÇ',
                        'Ê≠£Áæ©„Å®„ÅØ‰Ωï„Åã„ÄÅËÄÉ„Åà„Åü„Åì„Å®„ÅØ„ÅÇ„Çã„ÅãÔºü',
                        '‰ø∫„Åü„Å°„ÇÇË™ç„ÇÅ„Çâ„Çå„Åü„ÅÑ„Çì„Å†„ÄÇ',
                        'ÈÄÉ„Åí„Çã„Çπ„Ç≠„É´„ÇÇÂ§ß‰∫ã„Å†„Åû„ÄÇ',
                        'Âêõ„ÄÅÂº∑„ÅÑË¶öÊÇü„ÇíÊåÅ„Å£„Å¶„Çã„Å™„ÄÇ'
                    ]
                },
                {
                    name: 'Áã©‰∫∫', sprite: 'üèπ',
                    messages: [
                        'ÊÄ™Áâ©„Åü„Å°„ÅØÂº±„ÅÑÂÄã‰Ωì„Åã„ÇâÁãô„ÅÜ„ÅÆ„ÅåÂæóÁ≠ñ„Å†„ÄÇ',
                        'Ëá™ÁÑ∂„ÅÆ‰∏≠„ÅßÁîü„Åç„Çã„ÅÆ„ÅåÊúÄÈ´ò„Å†„ÄÇ',
                        'Áç≤Áâ©„ÇíËøΩ„ÅÜ„ÅÆ„ÅØÊ•Ω„Åó„ÅÑ„Åû„ÄÇ',
                        'Âêõ„ÇÇÁã©„Çä„ÅÆÊäÄ„ÇíÂ≠¶„Çì„Åß„Åø„Å™„ÄÇ',
                        'Ëá™ÁÑ∂„Å®ÂÖ±„Å´Áîü„Åç„Çã„ÅÆ„Åå‰ø∫„ÅÆÈÅì„Å†„ÄÇ',
                        'Âºì„ÇíÂºï„ÅèÊôÇ„ÅØÊ∑±ÂëºÂê∏„Çí„Åô„Çã„Çì„Å†„ÄÇ',
                        'Áç£„ÅÆÁóïË∑°„ÇíË™≠„ÇÄ„ÅÆ„ÅØÁµåÈ®ì„Å†„ÄÇ',
                        'Ëá™ÁÑ∂„ÇíÂ∞äÈáç„Åô„Çã„Åì„Å®„ÅåÂ§ß‰∫ã„Å†„ÄÇ',
                        'Áã©„Çä„ÅØ‰∫∫„Å®Áç£„ÅÆÂØæË©±„Å†„ÄÇ',
                        'Áç£„ÅØÂêõ„Çà„ÇäÈ†≠„Åå„ÅÑ„ÅÑ„Åã„ÇÇ„Åó„Çå„Å™„ÅÑ„Åû„ÄÇ',
                        'È¢®„ÇíË™≠„ÇÄ„Çì„Å†„ÄÇ',
                        'Ê≤àÈªô„ÅÆÁæéÂ≠¶„ÇíÁü•„Çã„Å®„ÅÑ„ÅÑ„ÄÇ',
                        'Áç≤Áâ©„ÇÇÁîü„Åç„Å¶„ÅÑ„Çã„ÄÇÊï¨ÊÑè„ÇíÊåÅ„Å¶„ÄÇ',
                        'Âêõ„Å´„ÅØÁã©‰∫∫„ÅÆÁ¥†Ë≥™„Åå„ÅÇ„Çã„ÄÇ'
                    ]
                },
                {
                    name: 'ÂïÜ‰∫∫„ÅÆÂ®ò', sprite: 'üëß',
                    messages: [
                        'ÊØéÊó•„ÅÑ„Çç„Çì„Å™‰∫∫„ÅåÈÄö„Å£„Å¶„ÅÑ„Åè„ÅÆ„ÇíË¶ã„Å¶„Çã„ÅÆ„ÄÇ',
                        'ÂÜíÈô∫ËÄÖ„Å£„Å¶„Åã„Å£„Åì„ÅÑ„ÅÑ„Å≠ÔºÅ',
                        '„Å©„Åì„Åã„ÇâÊù•„Åü„Çì„Åß„Åô„ÅãÔºü',
                        'ÁßÅ„ÇÇ„ÅÑ„Å§„ÅãÂÜíÈô∫ËÄÖ„Å´„Å™„Çä„Åü„ÅÑ„Å™„ÄÇ',
                        '‰∏ñÁïå„ÇíË¶ã„Å¶Âõû„Çä„Åü„ÅÑ„Å™„ÄÇ',
                        'Áà∂„Åï„Çì„ÅÆÂ∫ó„ÅØ„ÅÑ„Å§„ÇÇÂøô„Åó„ÅÑ„ÅÆ„ÄÇ',
                        '„ÅÑ„Çç„Çì„Å™Ë©±„ÇíËÅû„Åè„ÅÆ„ÅåÂ•Ω„Åç„Åß„Åô„ÄÇ',
                        '„ÅäÊØç„Åï„Çì„ÅåÂêõ„ÅØËâØ„ÅÑ‰∫∫„Å†„Å£„Å¶Ë®Ä„Å£„Å¶„Åü„Çà„ÄÇ',
                        '„ÅÑ„Å§„Åã‰øÆË°å„Å´Âá∫„Åü„ÅÑ„Å™„ÄÇ',
                        'Âêõ„ÅÆÂÜíÈô∫„ÅÆË©±„ÇíËÅû„Åã„Åõ„Å¶ÔºÅ',
                        'Â§ñ„ÅÆ‰∏ñÁïå„ÅØÊÄñ„ÅÑ„Åë„Å©ÊÜß„Çå„Çã„ÅÆ„ÄÇ',
                        '„ÅÑ„Å§„Åã„Åì„ÅÆÁî∫„ÇíÂá∫„Çã„Çì„Å†„ÄÇ',
                        'Âº∑„Åè„Å™„Çã„Å£„Å¶„Å©„Çì„Å™Ê∞óÂàÜ„Å™„Çì„Å†„Çç„ÅÜÔºü',
                        'Âêõ„ÇÇÈ†ëÂºµ„Å£„Å¶„Å≠ÔºÅ'
                    ]
                },
                {
                    name: 'ËÄÅ‰∫∫', sprite: 'üë¥',
                    messages: [
                        'Êòî„ÅØ„Åì„Åì„ÇÇÊ†Ñ„Åà„Å¶„ÅÑ„Åü„Çì„Å†„Çà„ÄÇ',
                        'Âπ¥„Å´„ÅØÂãù„Å¶„Å™„ÅÑ„Å≠„Åá„ÄÇ',
                        'Ëã•„ÅÑÈ†É„ÅÆÊÄù„ÅÑÂá∫„ÅåÂ§ß‰∫ã„Å†„ÄÇ',
                        'Âêõ„Åü„Å°„ÅåÂ∏åÊúõ„Å†„Çà„ÄÇ',
                        '‰∫∫Áîü„ÅØÁü≠„ÅÑ„Çà„ÅÜ„ÅßÈï∑„ÅÑ„Çà„ÅÜ„Åß„ÄÅ‰∏çÊÄùË≠∞„Å†„Å≠„Åá„ÄÇ',
                        '„ÅÇ„ÅÆÈ†É„ÅØÊú¨ÂΩì„Å´ËâØ„Åã„Å£„Åü„Å™„ÅÅ„ÄÇ',
                        'ÊôÇÈñì„Å†„Åë„Åå‰ø∫„Åü„Å°„ÇíÁôí„Åô„Çì„Å†„ÄÇ',
                        '„Å©„Çì„Å™„Å´Âº∑„Åè„Å¶„ÇÇËÄÅ„ÅÑ„Å´„ÅØÂãù„Å¶„Å™„ÅÑ„Çì„Å†„ÄÇ',
                        'ÁµåÈ®ì„ÇíÁîü„Åã„Åó„Å¶„Åè„Çå„Çà„ÄÇ',
                        '‰Ωï„ÅãËÅû„Åç„Åü„ÅÑ„Åì„Å®„Åå„ÅÇ„Çå„Å∞Ë®Ä„ÅÑ„Å™„Åï„ÅÑ„ÄÇ',
                        'Ëã•„ÅÑÈ†É„ÅÆÂ§±Êïó„ÅØÂÆùÁâ©„Å†„ÄÇ',
                        'Áîü„Åç„Çã„Åì„Å®„ÅåÂ§ß‰∫ã„Å™„Çì„Å†„ÄÇ',
                        'Âêõ„Åü„Å°„ÇíË¶ã„Å¶„Çã„Å®Ëã•Ëøî„Å£„ÅüÊ∞ó„Åå„Åô„Çã„Çà„ÄÇ',
                        'È†ëÂºµ„Å£„Å¶„Åä„Åè„Çå„ÄÇ'
                    ]
                },
                {
                    name: 'Â∞ëÂπ¥', sprite: 'üë¶',
                    messages: [
                        '„ÅÑ„Å§„ÅãÂÜíÈô∫ËÄÖ„Å´„Å™„Çã„ÅÆ„ÅåÂ§¢„Å™„Çì„Å†ÔºÅ',
                        'Âêõ„Åø„Åü„ÅÑ„Å´Âº∑„Åè„Å™„Çä„Åü„ÅÑÔºÅ',
                        'ÊØéÊó•Ë®ìÁ∑¥„Åó„Å¶„Çã„Çì„Å†„ÄÇ',
                        '‰∏ñÁïå„Å£„Å¶„Å©„Çì„Å™„Å®„Åì„ÇçÔºü',
                        'Âêõ„ÅÆË©±„ÇíËÅû„Åã„Åõ„Å¶„ÇàÔºÅ',
                        'Âº∑„ÅÑ„Å£„Å¶Êú¨ÂΩì„Å´„Åã„Å£„Åì„ÅÑ„ÅÑ„ÅÆÔºü',
                        'ÂÉï„ÇÇÊó©„ÅèÂÜíÈô∫„Å´Ë°å„Åç„Åü„ÅÑÔºÅ',
                        'Ââ£„Çí„Åè„Çå„Åæ„Åõ„Çì„ÅãÔºÅÔºü',
                        'Âêõ„Å£„Å¶Êú¨ÂΩì„Å´„Åô„Åî„ÅÑ„Çì„Å†„Å≠ÔºÅ',
                        '„Å©„ÅÜ„Åó„Åü„Çâ„Åù„Çì„Å™„Å´Âº∑„Åè„Å™„Çå„Çã„ÅÆÔºü',
                        'ÂÉï„ÅÆ‰øÆË°å„ÇíË¶ã„Å¶„Åè„Çå„Å™„ÅÑÔºü',
                        'Âêõ„ÅÆÂÜíÈô∫„ÅØ„Å©„Åì„Åã„ÇâÂßã„Åæ„Å£„Åü„ÅÆÔºü',
                        'ÂÉï„Å†„Å£„Å¶È†ëÂºµ„Çã„ÅûÔºÅ',
                        'ÂøúÊè¥„Åó„Å¶„Çã„Åã„Çâ„Å≠ÔºÅ'
                    ]
                },
                {
                    name: 'Âç†„ÅÑÂ∏´', sprite: 'üîÆ',
                    messages: [
                        'Âêõ„ÅÆÈÅãÂã¢„ÅØ‰∏äÊòáÂÇæÂêë„Å´„ÅÇ„Çã„Å≠„ÄÇ',
                        'Êú™Êù•„ÅØÂ§â„Åà„Çâ„Çå„Çã„ÇÇ„ÅÆ„Å†„ÄÇ',
                        'Êòü„Åü„Å°„ÅåÂêõ„Å´Ë™û„Çä„Åã„Åë„Å¶„ÅÑ„Çã„Çà„ÄÇ',
                        'Â§ßÂàá„Å™„Åì„Å®„ÇíË¶ãÂ§±„Çè„Å™„ÅÑ„Çà„ÅÜ„Å´„ÄÇ',
                        'Âêõ„ÅÆÈÅì„ÅØËºù„ÅÑ„Å¶„ÅÑ„Çã„ÄÇ',
                        '„Å©„Çì„Å™Êú™Êù•„ÅåË¶ã„Åü„ÅÑÔºü',
                        'Âç†„ÅÑ„ÅØÂèØËÉΩÊÄß„ÇíÁ§∫„Åô„Å†„Åë„Å†„ÄÇ',
                        'ÂÆøÂëΩ„Å®ÈÅãÂëΩ„ÅØÈÅï„ÅÜ„Çì„Å†„ÄÇ',
                        'Ëø∑„Å£„ÅüÊôÇ„ÅØÂç†„ÅÑ„Çí‰ø°„Åò„Åô„Åé„Çã„Å™„ÄÇ',
                        'Ëá™ÂàÜ„ÅÆÁõ¥ÊÑü„Çí‰ø°„Åò„Çã„Çì„Å†„ÄÇ',
                        'Êòü„ÅØË™∞„Å´„Åß„ÇÇÂÖâ„Çí‰∏é„Åà„Çã„ÄÇ',
                        'ÈÅéÂéª„ÅØÂ§â„Åà„Çâ„Çå„Å™„ÅÑ„ÅåÊú™Êù•„ÅØÂ§â„Çè„Çã„ÄÇ',
                        'Âêõ„Å´„ÅØÁâπÂà•„Å™‰Ωï„Åã„Åå„ÅÇ„Çã„ÄÇ',
                        'ÈÅãÂëΩ„Å´Ë∫´„Çí‰ªª„Åõ„Çã„ÅÆ„Åß„ÅØ„Å™„ÅèÂàá„ÇäÈñã„Åè„Çì„Å†„ÄÇ'
                    ]
                },
                {
                    name: 'È®éÂ£´', sprite: '‚öî',
                    messages: [
                        'ÂêçË™â„Å®„ÅØÂº∑„Åï„Çà„Çä„ÇÇÁ≤æÁ•û„ÅÆÂú®„ÇäÊñπ„ÅåÈáçË¶Å„Å†„ÄÇ',
                        'Ë≤¥Êóè„Å®„Åó„Å¶„ÅÆË™á„Çä„ÇíÊåÅ„Å§„Çì„Å†„ÄÇ',
                        'Ê≠£Áæ©„ÅÆ„Åü„ÇÅ„Å´Êà¶„ÅÜ„ÅÆ„Åå‰ø∫„Åü„Å°„ÅÆÂãô„ÇÅ„Å†„ÄÇ',
                        'Âº±„ÅçËÄÖ„ÇíÂÆà„Çã„ÅÆ„ÅåÈ®éÂ£´„ÅÆÂΩπÁõÆ„Å†„ÄÇ',
                        'Ââ£„Å®ÂøÉ„ÇíÁ£®„ÅçÁ∂ö„Åë„Çã„ÅÆ„ÅåÈÅì„Å†„ÄÇ',
                        'ÊÅêÊÄñ„Å´Ë≤†„Åë„Çã„Å™„ÄÇ',
                        '‰∏ÄÈ®éÂΩìÂçÉ„ÅÆÊ∞óÊ¶Ç„ÇíÊåÅ„Å¶„ÄÇ',
                        'È¶¨Ë°ì„ÇíÊ•µ„ÇÅ„Çã„ÅÆ„ÇÇÈ®éÂ£´„ÅÆÂãô„ÇÅ„Å†„ÄÇ',
                        'Á§ºÂÑÄ„ÇíÂøò„Çå„Çã„Å™„ÄÇ',
                        'Êïµ„ÇíÂ∞äÈáç„Åô„Çã„Åì„Å®„ÇÇÂ§ß‰∫ã„Å†„ÄÇ',
                        'Âãù„Å§„Å†„Åë„ÅåËâØ„ÅÑÊà¶„ÅÑ„Åò„ÇÉ„Å™„ÅÑ„ÄÇ„Å©„ÅÜÂãù„Å§„Åã„Å†„ÄÇ',
                        'Ê∞ë„ÇíÂÆà„ÇãË¶öÊÇü„Åå„ÅÇ„Çã„ÅãÔºü',
                        'Áúü„ÅÆÂº∑„Åï„ÅØÁ≤æÁ•û„Å´„ÅÇ„Çã„ÄÇ',
                        'Âêõ„Å´„ÇÇÈ®éÂ£´„ÅÆÁ¥†Ë≥™„Åå„ÅÇ„Çã„ÄÇ'
                    ]
                },
                {
                    name: 'Âß´', sprite: 'üíé',
                    messages: [
                        'ÂÜíÈô∫„ÅØÊú¨ÂΩì„Å´„É≠„Éû„É≥„ÉÅ„ÉÉ„ÇØ„Åß„Åô„Å≠„ÄÇ',
                        'Â§ñ„ÅÆ‰∏ñÁïå„ÇíË¶ã„Å¶„Åø„Åü„ÅÑ„Åß„Åô„ÄÇ',
                        'Âüé„ÅÆ‰∏≠„ÅÆÁîüÊ¥ª„ÅØÈÄÄÂ±à„Å™„Çì„Åß„Åô„ÄÇ',
                        'Âêõ„ÅÆ„Çà„ÅÜ„Å™ÂÜíÈô∫ËÄÖ„Å´ÊÜß„Çå„Åæ„Åô„ÄÇ',
                        '„ÅÑ„Å§„ÅãËá™ÂàÜ„ÅÆÈÅì„ÇíÊ≠©„Åø„Åü„ÅÑ„ÄÇ',
                        'Áà∂„ÅØÂèçÂØæ„Åô„Çã„Åß„Åó„Çá„ÅÜ„Åë„Å©‚Ä¶‚Ä¶„ÄÇ',
                        'Ëá™Áî±„Å£„Å¶‰Ωï„Å™„Çì„Åß„Åó„Çá„ÅÜÔºü',
                        'Âêõ„ÅÆË©±„ÄÅ„Å®„Å¶„ÇÇÊ•Ω„Åó„ÅÑ„Åß„Åô„ÄÇ',
                        '‰∏ñÁïå„Å£„Å¶„Åì„Çì„Å™„Å´Â∫É„ÅÑ„Çì„Åß„Åô„Å≠„ÄÇ',
                        'ÂÜíÈô∫„Å´ÈÄ£„Çå„Å¶Ë°å„Å£„Å¶„Åè„Çå„Åæ„Åõ„Çì„ÅãÔºü',
                        'Ë≤¥Êóè„ÅÆË∫´„Åß„ÅÇ„Çã„Åì„Å®„ÅåÊôÇ„ÄÖ„Å§„Çâ„Åè„Å™„Çä„Åæ„Åô„ÄÇ',
                        'Âêõ„ÅØËá™ÂàÜ„ÅÆÈÅì„ÇíÊ±∫„ÇÅ„Å¶„ÅÑ„Çã„Çì„Åß„Åô„Å≠„ÄÇ',
                        'È°ò„ÅÑ„ÅØÂè∂„ÅÜ„ÇÇ„ÅÆ„Å™„ÅÆ„Åß„Åó„Çá„ÅÜ„Åã„ÄÇ',
                        'ÁßÅ„ÇÇÂ§â„Çè„Çä„Åü„ÅÑ„Çì„Åß„Åô„ÄÇ'
                    ]
                },
                {
                    name: 'ÂåªËÄÖ', sprite: '',
                    messages: [
                        '„ÇÑ„Åè„Åù„ÅÜ„Å™„ÇâÂÆâ„Åè„Å¶„Çà„ÅèÂäπ„Åè„Çà„ÄÇ',
                        'ÊÄ™Êàë„Çí„Åó„Åü„ÇâÁõ∏Ë´á„Åó„Å¶„Åè„Çå„ÄÇ',
                        '‰∫àÈò≤„Åå‰∏ÄÁï™„ÅÆÂåªÁôÇ„Å†„ÄÇ',
                        'ÊÇ£ËÄÖ„ÅÆË©±„Çí„Çà„ÅèËÅû„Åè„Çì„Å†„ÄÇ',
                        'ÂøÉ„ÅÆÁóÖ„ÇÇÊ≤ªÁôÇ„ÅÆÂØæË±°„Å†„ÄÇ',
                        'ÊØéÊó•„ÅåÂëΩ„ÅÆÁèæÂ†¥„Å†„ÄÇ',
                        'Ëñ¨„Å†„Åë„Åò„ÇÉ„Å™„ÅèÂøÉ„ÇÇÁôí„Åô„Çì„Å†„ÄÇ',
                        'Áñ≤„Çå„Åü„Çâ‰ºë„ÇÄ„Çì„Å†„ÄÇ',
                        'Ê≠ª„Å®Âêë„ÅçÂêà„ÅÜ‰ªï‰∫ã„Å†„ÄÇ',
                        'Âêõ„ÅÆ‰ΩìË™ø„ÅØÂ§ß‰∏àÂ§´„ÅãÔºü',
                        'ÂåªÂ≠¶„ÅØÊó•„ÄÖÈÄ≤Âåñ„Åó„Å¶„ÅÑ„Çã„ÄÇ',
                        '„Å©„Çì„Å™ÁóÖ„Åß„ÇÇË´¶„ÇÅ„Çã„Å™„ÄÇ',
                        'ÂëΩ„ÇíÂ§ß‰∫ã„Å´„Åó„Å¶„Åè„Çå„ÄÇ',
                        'ÂÇ∑„ÇíÊîæÁΩÆ„Åó„Å¶„ÅØ„ÅÑ„Åë„Å™„ÅÑ„Çà„ÄÇ'
                    ]
                }            
            ],

            spells: {
                '„Éï„Ç°„Ç§„Ç¢': {mp:3, power:10, target:'single'},
                '„Ç§„Ç™': {mp:8, power:20, target:'all'},
                '„Éí„Éº„É´': {mp:4, power:20, target:'ally'},
                '„Éñ„É™„Ç∂„Éº„Éâ': {mp:5, power:15, target:'single'},
                '„Çπ„É™„Éº„Éó': {mp:6, power:0, target:'single'}
            },
            aptitudes: ['Êà¶Â£´„Çø„Ç§„Éó','È≠îÊ≥ï‰Ωø„ÅÑ„Çø„Ç§„Éó','ÂÉß‰æ∂„Çø„Ç§„Éó','ÁõóË≥ä„Çø„Ç§„Éó','Áã©‰∫∫„Çø„Ç§„Éó','Á¥†Ë≥™„Å™„Åó„Çø„Ç§„Éó'],

            shops: {
                'weapon_shop_1': {
                    name: '„Å∂„Åç„ÇÑÂàùÁ¥ö',
                    items: [
                        {name: '„Å≤„ÅÆ„Åç„ÅÆ„Åº„ÅÜ', attack: 2, price: 50, type: 'weapon', ranged: false},
                        {name: '„Ç∑„Éß„Éº„Éà„Éú„Ç¶', attack: 4, price: 140, type: 'weapon', ranged: true},
                        {name: '„Å©„ÅÜ„ÅÆ„Å§„Çã„Åé', attack: 5, price: 150, type: 'weapon', ranged: false}
                    ]
                },
                'armor_shop_1': {
                    name: '„Åº„ÅÜ„Åê„ÇÑ',
                    items: [
                        {name: '„Å¨„ÅÆ„ÅÆ„Åµ„Åè', defense: 2, price: 50, type: 'armor'},
                        {name: '„Åã„Çè„ÅÆ„Åº„ÅÜ„Åó', defense: 1, price: 40, type: 'helmet'}
                    ]
                },
                'weapon_shop_2': {
                    name: '„Å∂„Åç„ÇÑ‰∏≠Á¥ö',
                    items: [
                        {name: '„ÅØ„Åå„Å≠„ÅÆ„Å§„Çã„Åé', attack: 10, price: 500, type: 'weapon', ranged: false},
                        {name: '„É≠„É≥„Ç∞„Éú„Ç¶', attack: 12, price: 700, type: 'weapon', ranged: true},
                        {name: 'È≠îÂ∞é„ÅÆÊùñ', attack: 8, price: 650, type: 'weapon', ranged: true},
                        {name: '„Åª„ÅÆ„Åä„ÅÆ„Å§„Çã„Åé', attack: 20, price: 2000, type: 'weapon', ranged: false}
                    ]
                },
                'armor_shop_2': {
                    name: '„Åº„ÅÜ„Åê„ÇÑ‰∏≠Á¥ö',
                    items: [
                        {name: '„Åè„Åï„Çä„Åã„Åü„Å≥', defense: 10, price: 500, type: 'armor'},
                        {name: '„Å¶„Å§„ÅÆ„Åã„Å∂„Å®', defense: 3, price: 120, type: 'helmet'}
                    ]
                },
                'inn': {
                    name: '„ÇÑ„Å©„ÇÑ',
                    price: 50
                }
            },

            init() {
                this.gameOverFlag = false;
                if (!this.player.aptitude) this.player.aptitude = this.getRandomAptitude();
                this.initAudio();
                this.selectedFieldMusic = this.chooseFieldMusicSource();
                this.generateMap();
                this.ensurePlayerStartOnGrass();
                this.updatePlayerPosition();
                this.updateStatus();
                document.addEventListener('keydown', (e) => this.handleInput(e));
                
                // „É¶„Éº„Ç∂„Éº„Ç§„É≥„Çø„É©„ÇØ„Ç∑„Éß„É≥„ÅßÈü≥Ê•Ω„ÇíÔøΩEÁîü„Åß„Åç„Çã„Çà„ÅÜ„Å´„Åô„Çã
                const startMusic = () => {
                    this.playFieldMusic();
                    document.removeEventListener('click', startMusic);
                    document.removeEventListener('keydown', startMusic);
                };
                document.addEventListener('click', startMusic);
                document.addEventListener('keydown', startMusic);
                
                // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔøΩEÔøΩÔøΩEÊúüÂåñ„Åã„Çâ1ÁßíÂæå„Å´Âº∑Âà∂ÁöÅEÔøΩÔøΩÂÜçÁîüË©¶Ë°ÅE                
                setTimeout(() => {
                    if (!this.currentMusic) {
                        this.playFieldMusic();
                    }
                }, 1000);
            },

            initAudio() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('Web Audio API not supported');
                }
            },

            createTone(frequency, duration, volume = 0.1, type = 'sine') {
                if (!this.audioContext) return null;
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                gainNode.gain.setValueAtTime(volume, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);
                return { oscillator, gainNode, duration };
            },

            playFieldMusic() {
                this.stopMusic();
                const fieldMusic = document.getElementById('field-music');
                if (fieldMusic && this.musicEnabled) {
                    if (this.selectedFieldMusic) {
                        fieldMusic.src = this.selectedFieldMusic;
                    }
                    fieldMusic.currentTime = 0;
                    fieldMusic.play().catch(e => console.log('Cannot play field music:', e));
                    this.currentMusic = { type: 'field' };
                }
            },

            playBattleMusic() {
                this.stopMusic();
                // 3„Å§„ÅÆÊà¶ÈóòÈü≥Ê•Ω„Çí„É©„É≥„ÉÄ„É†„Å´ÈÅ∏ÊäÅE                this.battleMusicIndex = Math.floor(Math.random() * 3) + 1; // 1, 2, 3„ÅÆ„ÅÜ<ÔøΩÔøΩ„Çå„Åã
                const battleMusic = document.getElementById(`battle-music-${this.battleMusicIndex}`);
                if (battleMusic && this.musicEnabled) {
                    battleMusic.currentTime = 0;
                    battleMusic.play().catch(e => console.log('Cannot play battle music:', e));
                    this.currentMusic = { type: 'battle' };
                }
            },

            playShopMusic() {
                this.stopMusic();
                this.inShop = true;
                const shopMusic = document.getElementById('shop-music');
                if (shopMusic && this.musicEnabled) {
                    shopMusic.currentTime = 0;
                    shopMusic.play().catch(e => console.log('Cannot play shop music:', e));
                    this.currentMusic = { type: 'shop' };
                }
            },

            stopMusic() {
                const fieldMusic = document.getElementById('field-music');
                const shopMusic = document.getElementById('shop-music');
                for (let i = 1; i <= 3; i++) {
                    const battleMusic = document.getElementById(`battle-music-${i}`);
                    if (battleMusic) {
                        battleMusic.pause();
                        battleMusic.currentTime = 0;
                    }
                }
                if (fieldMusic) {
                    fieldMusic.pause();
                    fieldMusic.currentTime = 0;
                }
                if (shopMusic) {
                    shopMusic.pause();
                    shopMusic.currentTime = 0;
                }
                if (this.currentMusic && this.currentMusic.timeouts) {
                    this.currentMusic.timeouts.forEach(timeout => clearTimeout(timeout));
                }
                this.currentMusic = null;
            },

            toggleMusic() {
                this.musicEnabled = !this.musicEnabled;
                const btn = document.getElementById('music-toggle-btn');
                if (this.musicEnabled) {
                    btn.textContent = 'Èü≥Ê•ΩÂÅúÊ≠¢';
                    if (!this.inBattle) {
                        this.playFieldMusic();
                    }
                } else {
                    btn.textContent = 'Èü≥Ê•ΩÂÜçÈñã';
                    this.stopMusic();
                }
            },

            playSoundEffect(soundId) {
                const sound = document.getElementById(soundId);
                if (sound && this.musicEnabled) {
                    sound.currentTime = 0;
                    sound.play().catch(e => console.log(`Cannot play sound ${soundId}:`, e));
                }
            },

            fadeOutMusic(duration = 1000) {
                const battleMusic = document.getElementById(`battle-music-${this.battleMusicIndex}`);
                if (battleMusic && this.musicEnabled) {
                    const startTime = Date.now();
                    const initialVolume = battleMusic.volume;
                    
                    const fadeInterval = setInterval(() => {
                        const elapsed = Date.now() - startTime;
                        const progress = Math.min(elapsed / duration, 1);
                        battleMusic.volume = initialVolume * (1 - progress);
                        
                        if (progress >= 1) {
                            clearInterval(fadeInterval);
                            battleMusic.pause();
                            battleMusic.volume = 1; // Èü≥Èáè„Çí„É™„Çª„ÉÅEÔøΩÔøΩ
                        }
                    }, 50);
                }
            },

            shakeScreen(duration = 400) {
                const gameScreen = document.getElementById('game-screen');
                gameScreen.classList.add('shake');
                setTimeout(() => {
                    gameScreen.classList.remove('shake');
                }, duration);
            },

            shakeEnemy(enemyIndex, duration = 400) {
                const enemies = document.querySelectorAll('.enemy-container');
                if (enemies && enemies.length > enemyIndex && enemies[enemyIndex]) {
                    const enemy = enemies[enemyIndex];
                    enemy.classList.add('taking-damage');
                    setTimeout(() => {
                        enemy.classList.remove('taking-damage');
                    }, duration);
                } else {
                    console.warn('Enemy not found at index', enemyIndex);
                }
            },

            ensurePlayerStartOnGrass() {
                // „Éó„É¨„Ç§„É§„Éº„ÅÆÈñãÂßã‰ΩçÁΩÆ„ÅåÊ∞¥„ÇÅEÔøΩÔøΩ„Åß„Å™„ÅÜ<ÔøΩÔøΩ„Å®„ÇíÁ¢∫Ë™ÅE                
                while (this.map[this.player.y][this.player.x] === 'water' || 
                       this.map[this.player.y][this.player.x] === 'mountain') {
                    let found = false;
                    for (let radius = 1; radius < 20 && !found; radius++) {
                        for (let dy = -radius; dy <= radius && !found; dy++) {
                            for (let dx = -radius; dx <= radius && !found; dx++) {
                                const newX = this.player.x + dx;
                                const newY = this.player.y + dy;
                                if (newX >= 0 && newX < this.mapSize && 
                                    newY >= 0 && newY < this.mapSize) {
                                    const tile = this.map[newY][newX];
                                    if (tile === 'grass' || tile === 'forest') {
                                        this.player.x = newX;
                                        this.player.y = newY;
                                        found = true;
                                    }
                                }
                            }
                        }
                    }
                    if (!found) {
                        // Ë¶ã„Å§„Åã„Çâ„Å™„ÅÜ<ÔøΩÔøΩÂêàÔøΩEÂº∑Âà∂ÁöÅEÔøΩÔøΩËçâÂéü„Å´Â§âÊõ¥
                        this.map[this.player.y][this.player.x] = 'grass';
                        break;
                    }
                }
            },

            generateMap() {
                const field = document.getElementById('field');
                field.innerHTML = '';
                
                // „Éû„ÉÉ„Éó„ÇíËçâÂéü„ÅßÂàùÊúüÂåÅE                
                for (let y = 0; y < this.mapSize; y++) {
                    this.map[y] = [];
                    for (let x = 0; x < this.mapSize; x++) {
                        this.map[y][x] = 'grass';
                    }
                }
                
                // Ê∞¥Âüü„ÇíÁîüÔøΩE
                for (let i = 0; i < 15; i++) {
                    const centerX = Math.floor(Math.random() * this.mapSize);
                    const centerY = Math.floor(Math.random() * this.mapSize);
                    const size = 5 + Math.floor(Math.random() * 10);
                    for (let dy = -size; dy <= size; dy++) {
                        for (let dx = -size; dx <= size; dx++) {
                            if (dx * dx + dy * dy <= size * size) {
                                const nx = centerX + dx;
                                const ny = centerY + dy;
                                if (nx >= 0 && nx < this.mapSize && ny >= 0 && ny < this.mapSize) {
                                    this.map[ny][nx] = 'water';
                                }
                            }
                        }
                    }
                }
                
                // Â±±„ÇíÁîüÊàÅE                
                for (let i = 0; i < 20; i++) {
                    const centerX = Math.floor(Math.random() * this.mapSize);
                    const centerY = Math.floor(Math.random() * this.mapSize);
                    const size = 3 + Math.floor(Math.random() * 6);
                    for (let dy = -size; dy <= size; dy++) {
                        for (let dx = -size; dx <= size; dx++) {
                            if (dx * dx + dy * dy <= size * size && this.map[centerY + dy]?.[centerX + dx] === 'grass') {
                                const nx = centerX + dx;
                                const ny = centerY + dy;
                                if (nx >= 0 && nx < this.mapSize && ny >= 0 && ny < this.mapSize) {
                                    this.map[ny][nx] = 'mountain';
                                }
                            }
                        }
                    }
                }
                
                // Ê£Æ„ÇíÁîüÊàÅE                
                for (let i = 0; i < 25; i++) {
                    const centerX = Math.floor(Math.random() * this.mapSize);
                    const centerY = Math.floor(Math.random() * this.mapSize);
                    const size = 4 + Math.floor(Math.random() * 8);
                    for (let dy = -size; dy <= size; dy++) {
                        for (let dx = -size; dx <= size; dx++) {
                            if (dx * dx + dy * dy <= size * size && this.map[centerY + dy]?.[centerX + dx] === 'grass') {
                                const nx = centerX + dx;
                                const ny = centerY + dy;
                                if (nx >= 0 && nx < this.mapSize && ny >= 0 && ny < this.mapSize) {
                                    this.map[ny][nx] = 'forest';
                                }
                            }
                        }
                    }
                }
                
                // Á†ÇÊº†„ÇíÁîüÊàÅE                
                for (let i = 0; i < 10; i++) {
                    const centerX = Math.floor(Math.random() * this.mapSize);
                    const centerY = Math.floor(Math.random() * this.mapSize);
                    const size = 6 + Math.floor(Math.random() * 10);
                    for (let dy = -size; dy <= size; dy++) {
                        for (let dx = -size; dx <= size; dx++) {
                            if (dx * dx + dy * dy <= size * size && this.map[centerY + dy]?.[centerX + dx] === 'grass') {
                                const nx = centerX + dx;
                                const ny = centerY + dy;
                                if (nx >= 0 && nx < this.mapSize && ny >= 0 && ny < this.mapSize) {
                                    this.map[ny][nx] = 'desert';
                                }
                            }
                        }
                    }
                }
                
                // Èõ™Âéü„ÇíÁîüÔøΩE
                for (let i = 0; i < 8; i++) {
                    const centerX = Math.floor(Math.random() * this.mapSize);
                    const centerY = Math.floor(Math.random() * this.mapSize);
                    const size = 5 + Math.floor(Math.random() * 8);
                    for (let dy = -size; dy <= size; dy++) {
                        for (let dx = -size; dx <= size; dx++) {
                            if (dx * dx + dy * dy <= size * size && this.map[centerY + dy]?.[centerX + dx] === 'grass') {
                                const nx = centerX + dx;
                                const ny = centerY + dy;
                                if (nx >= 0 && nx < this.mapSize && ny >= 0 && ny < this.mapSize) {
                                    this.map[ny][nx] = 'snow';
                                }
                            }
                        }
                    }
                }
                
                // Ê≤ºÂú∞„ÇíÁîüÊàÅE                
                for (let i = 0; i < 12; i++) {
                    const centerX = Math.floor(Math.random() * this.mapSize);
                    const centerY = Math.floor(Math.random() * this.mapSize);
                    const size = 3 + Math.floor(Math.random() * 5);
                    for (let dy = -size; dy <= size; dy++) {
                        for (let dx = -size; dx <= size; dx++) {
                            if (dx * dx + dy * dy <= size * size && this.map[centerY + dy]?.[centerX + dx] === 'grass') {
                                const nx = centerX + dx;
                                const ny = centerY + dy;
                                if (nx >= 0 && nx < this.mapSize && ny >= 0 && ny < this.mapSize) {
                                    this.map[ny][nx] = 'swamp';
                                }
                            }
                        }
                    }
                }
                
                // Ê¥ûÁ™ü„ÇíÁîüÔøΩE
                for (let i = 0; i < 5; i++) {
                    const x = Math.floor(Math.random() * this.mapSize);
                    const y = Math.floor(Math.random() * this.mapSize);
                    if (this.map[y][x] === 'mountain') {
                        this.map[y][x] = 'cave';
                    }
                }
                
                // Áî∫„Å®Â∫ó„ÇíÈÖçÁΩÆÔøΩEÔøΩ„Çπ„Çø„Éº„ÉàÂú∞ÁÇπ„Åã„ÇâËøë„ÅÑÈ†ÅEÔøΩÔøΩÈÖçÁΩÆÔøΩEÔøΩE                
                const buildings = [
                    {x: 50, y: 45, type: 'town'},
                    {x: 48, y: 42, type: 'weapon_shop_1'},  // ÂàùÁ¥öÊ≠¶Âô®Â±ãÔºàËøë„ÅÑÔøΩEÔøΩE                    
                    {x: 52, y: 42, type: 'armor_shop_1'},   // ÂàùÁ¥öÈò≤ÂÖ∑Â±ãÔºàËøë„ÅÑÔøΩEÔøΩE                    
                    {x: 50, y: 38, type: 'inn'},            // ÂÆøÂ±ãÔºàËøë„ÅÑÔøΩEÔøΩE                    
                    {x: 70, y: 30, type: 'weapon_shop_2'},  // ‰∏≠Á¥öÊ≠¶Âô®Â±ãÔºàÈÅ†„ÅÜ<ÔøΩÔøΩE                    
                    {x: 30, y: 70, type: 'armor_shop_2'}    // ‰∏≠Á¥öÈò≤ÂÖ∑Â±ãÔºàÈÅ†„ÅÜ<ÔøΩÔøΩE                
                    ];
                buildings.forEach(b => {
                    for (let dy = -3; dy <= 3; dy++) {
                        for (let dx = -3; dx <= 3; dx++) {
                            const nx = b.x + dx;
                            const ny = b.y + dy;
                            if (nx >= 0 && nx < this.mapSize && ny >= 0 && ny < this.mapSize) {
                                this.map[ny][nx] = 'grass';
                            }
                        }
                    }
                    this.map[b.y][b.x] = b.type;
                });
                
                // „Çø„Ç§„É´„ÇíÊèèÁîª
                for (let y = 0; y < this.mapSize; y++) {
                    for (let x = 0; x < this.mapSize; x++) {
                        const tile = document.createElement('div');
                        tile.className = 'tile ' + this.map[y][x];
                        field.appendChild(tile);
                    }
                }
                
                this.updateCamera();
            },

            handleInput(e) {
                if (this.gameOverFlag) return;
                if (this.inBattle) return;
                const menuOpen = document.getElementById('equipment-menu') && document.getElementById('equipment-menu').style.display === 'block' ||
                                 document.getElementById('shop-menu') && document.getElementById('shop-menu').style.display === 'block' ||
                                 document.getElementById('inn-menu') && document.getElementById('inn-menu').style.display === 'block';
                if (menuOpen) return;
                
                let newX = this.player.x, newY = this.player.y;
                switch(e.key) {
                    case 'ArrowUp': newY--; break;
                    case 'ArrowDown': newY++; break;
                    case 'ArrowLeft': newX--; break;
                    case 'ArrowRight': newX++; break;
                    default: return;
                }
                if (newX >= 0 && newX < this.mapSize && newY >= 0 && newY < this.mapSize) {
                    const tile = this.map[newY][newX];
                    if (tile !== 'water' && tile !== 'mountain') {
                        this.player.x = newX;
                        this.player.y = newY;
                        this.updatePlayerPosition();
                        this.updateCamera();
                        
                        // „Çø„Ç§„É´Á®ÆÂà•„Å´Âøú„Åò„Åü„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫                        
                        if (tile === 'town') {
                            this.showMessage('„Çà„ÅÜ„Åì„Åù„ÄÅÁî∫„Å∏„ÄÇ„Åì„Åì„ÅØÂÆâÂÖ®„Å™Â†¥ÊâÄ„Åß„Åô');
                        } else if (tile.startsWith('weapon_shop') || tile.startsWith('armor_shop')) {
                            this.openShop(tile);
                        } else if (tile === 'inn') {
                            this.openInn();
                        } else {
                            // „Ç®„É≥„Ç´„Ç¶„É≥„ÉàÂà§ÂÆöÔºàÂÆâÂÖ®„Å™Â†¥ÊâÄ‰ª•Â§ñ„Åß1„Çπ„ÉÜ„ÉÉ„ÉóÂæå„Å´Âà§ÂÆöÔºÅ
                            this.checkEncounter(tile);
                        }
                    }
                }
            },

            checkEncounter(tile) {
                // ÊØí„ÉÄ„É°„Éº„Ç∏„Çí‰∏é„Åà„ÇÅ
                if (this.player.poisoned) {
                    const result = this.applyPoisonTick(this.player, 'field');
                    if (result === 'player_dead') { this.gameOver(); return; }
                }
                for (const comp of this.companions.filter(c => c.alive !== false && c.poisoned)) {
                    const result = this.applyPoisonTick(comp, 'field');
                    if (result === 'player_dead') { this.gameOver(); return; }
                }

                let encounterRate = 0;
                
                if (tile === 'grass') {
                    encounterRate = 0.15;
                } else if (tile === 'forest') {
                    encounterRate = 0.35;
                } else if (tile === 'desert') {
                    encounterRate = 0.2;
                } else if (tile === 'swamp') {
                    encounterRate = 0.3;
                } else if (tile === 'snow') {
                    encounterRate = 0.25;
                } else if (tile === 'cave') {
                    this.showMessage('Ê¥ûÁ™ü„Å†ÔøΩEÔøΩÂº∑Êïµ„ÅåÊΩú„Çì„Åß„ÅÜ<ÔøΩÔøΩ„ÅÜ<ÔøΩÔøΩ...');
                    encounterRate = 0.5;
                }
                
                if (encounterRate > 0 && Math.random() < encounterRate) {
                    // „Ç®„É≥„Ç´„Ç¶„É≥„ÉàÂà§ÂÆöÔºöNPC„Å´‰ºö„ÅÜ„ÅãÊïµ„Å®Êà¶„ÅÜ
                    if (tile === 'grass' && Math.random() < 0.1 / 0.15) {
                        this.meetNPC();
                    } else {
                        this.startBattle(tile);
                    }
                }
            },

            updateCamera() {
                const container = document.getElementById('field-container');
                const offsetX = Math.min(Math.max(0, this.player.x - Math.floor(this.viewportWidth / 2)), this.mapSize - this.viewportWidth);
                const offsetY = Math.min(Math.max(0, this.player.y - Math.floor(this.viewportHeight / 2)), this.mapSize - this.viewportHeight);
                container.style.transform = `translate(-${offsetX * 30}px, -${offsetY * 30}px)`;
            },

            updatePlayerPosition() {
                const player = document.getElementById('player');
                const viewCenterX = Math.floor(this.viewportWidth / 2);
                const viewCenterY = Math.floor(this.viewportHeight / 2);
                
                let displayX = viewCenterX;
                let displayY = viewCenterY;
                
                // „Éû„ÉÉ„ÉóÁ´Ø„Å´„ÅÑ„ÇãÂ†¥Âêà„ÅÆË™øÊï¥
                if (this.player.x < viewCenterX) {
                    displayX = this.player.x;
                } else if (this.player.x >= this.mapSize - viewCenterX) {
                    displayX = this.viewportWidth - (this.mapSize - this.player.x);
                }
                
                if (this.player.y < viewCenterY) {
                    displayY = this.player.y;
                } else if (this.player.y >= this.mapSize - viewCenterY) {
                    displayY = this.viewportHeight - (this.mapSize - this.player.y);
                }
                
                player.style.left = displayX * 30 + 'px';
                player.style.top = displayY * 30 + 'px';
                
                // „É¨„Éô„É´„Å´„Çà„Å£„Å¶Ë¶ã„ÅüÁõÆ„ÇíÂ§âÊõ¥
                if (this.player.level >= 10) {
                    player.style.background = 'linear-gradient(135deg, #ffd700, #ffed4e)';
                    player.style.boxShadow = '0 0 15px rgba(255,215,0,0.8)';
                } else if (this.player.level >= 7) {
                    player.style.background = 'linear-gradient(135deg, #ff6b6b, #ffd700)';
                    player.style.boxShadow = '0 0 12px rgba(255,107,107,0.7)';
                } else if (this.player.level >= 4) {
                    player.style.background = 'linear-gradient(135deg, #4ecdc4, #44a5ff)';
                    player.style.boxShadow = '0 0 10px rgba(78,205,196,0.6)';
                } else {
                    player.style.background = '#ff0';
                    player.style.boxShadow = '0 0 10px rgba(255,255,0,0.5)';
                }
            },

            startBattle(currentTerrain = null) {
                this.inBattle = true;
                this.commandsLocked = false;
                this.battleEnded = false;
                this.damageHistory = {}; // „ÉÄ„É°„Éº„Ç∏Â±•Ê≠¥„Çí„É™„Çª„ÉÉ„Éà
                this.damageTakenMax = {}; // Ë¢´„ÉÄ„É°„Éº„Ç∏„ÅÆÊúÄÂ§ßÂÄ§„ÇíË®òÈå≤
                
                // „Éï„Ç©„Éº„É°„Éº„Ç∑„Éß„É≥ÂàùÊúüÂåñ                
                if (!this.player.formation) this.player.formation = 'front';
                this.companions.forEach(c => {
                    if (!c.formation) c.formation = 'front';
                });

                // ‰ª≤ÈñìÔøΩEÁîüÂ≠ò„ÉÅ„Çß„ÉÅEÔøΩÔøΩ
                this.aliveCompanions = this.companions.filter(c => c.alive !== false);
                
                // ÁèæÂú®„ÅÆ„ÉÅEÔøΩÔøΩ„Ç§„É≥„ÇíÂèñÂæóÔºàÊåáÂÆö„Åï„Çå„Å¶„ÅÜ<ÔøΩÔøΩ„ÅÜ<ÔøΩÔøΩÂêàÔºÅE                
                if (!currentTerrain) {
                    currentTerrain = this.map[this.player.y][this.player.x];
                }
                
                // „ÉÅEÔøΩÔøΩ„Ç§„É≥„Å´Âøú„Åò„Å¶Êïµ„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
                const availableEnemies = this.enemies.filter(enemy => 
                    enemy.terrain && enemy.terrain.includes(currentTerrain)
                );
                const baseList = availableEnemies.length > 0 ? availableEnemies : this.enemies;
                
                // „Éó„É¨„Ç§„É§„Éº„É¨„Éô„É´„Å´Âøú„Åò„Åü„ÉÜ„Ç£„Ç¢„Å®Ê∑∑ÂêàÁ¢∫Áéá„ÅßÂá∫Áèæ„ÉÜ„Ç£„Ç¢„ÇíÊ±∫ÂÆö                
                const targetTier = this.chooseTierByLevel();
                const tierPool = baseList.filter(e => this.getEnemyTier(e) === targetTier);
                
                // Âà©Áî®ÂèØËÉΩ„Å™Êïµ„Åå„Å™„ÅÑÂ†¥Âêà„Éô„Éº„Çπ„É™„Çπ„Éà„Åã„ÇâÈÅ∏Êäû                
                const pool = tierPool.length > 0 ? tierPool : baseList;
                
                // „É¨„Éô„É´„Å´Âøú„Åò„Å¶„Ç®„É≥„Ç´„Ç¶„É≥„ÉàÊï∞„ÇíË™øÊï¥
                let numEnemies;
                if (this.player.level <= 2) {
                    numEnemies = 1; // „É¨„Éô„É´1-2ÔºöÊïµ1‰Ωì                
                    } else if (this.player.level <= 4) {
                    numEnemies = Math.floor(Math.random() * 2) + 1; // „É¨„Éô„É´3-4ÔºöÊïµ1-2‰Ωì                
                    } else if (this.player.level <= 6) {
                    numEnemies = Math.floor(Math.random() * 2) + 2; // „É¨„Éô„É´5-6ÔºöÊïµ2-3‰Ωì                
                    } else {
                    numEnemies = Math.floor(Math.random() * 4) + 1; // „É¨„Éô„É´7‰ª•‰∏äÔºöÊïµ1-4‰Ωì                
                    }
                
                this.currentEnemies = [];
                for (let i = 0; i < numEnemies; i++) {
                    const enemy = JSON.parse(JSON.stringify(pool[Math.floor(Math.random() * pool.length)]));
                    enemy.id = i;
                    enemy.asleep = false;
                    
                    // ÂÄã‰Ωì„Åî„Å®„Å´„Çπ„ÉÜ„Éº„Çø„Çπ„Å´-20%„Åã„Çâ+20%„ÅÆ„É©„É≥„ÉÄ„É†Â§âÂãï„ÇíÂä†„Åà„Çã
                    const variationRate = (Math.random() * 0.4) - 0.2; // -0.2 „Åã„Çâ 0.2 (¬±20%)
                    enemy.hp = Math.max(1, Math.floor(enemy.hp * (1 + variationRate)));
                    enemy.attack = Math.max(1, Math.floor(enemy.attack * (1 + variationRate)));
                    enemy.defense = Math.max(0, Math.floor(enemy.defense * (1 + variationRate)));
                    enemy.exp = Math.max(1, Math.floor(enemy.exp * (1 + variationRate)));
                    enemy.gold = Math.max(1, Math.floor(enemy.gold * (1 + variationRate)));
                    enemy.speed = enemy.speed ? enemy.speed : 8 + Math.floor(Math.random() * 5);
                    
                    this.currentEnemies.push(enemy);
                }
                this.selectedEnemyIndex = 0;
                document.getElementById('field-container').style.display = 'none';
                document.getElementById('player').style.display = 'none';
                document.getElementById('battle-screen').style.display = 'flex';
                document.getElementById('battle-commands').style.display = 'grid';
                document.getElementById('magic-menu').style.display = 'none';
                document.getElementById('item-menu').style.display = 'none';
                this.renderEnemies();
                this.renderParty();
                const names = this.currentEnemies.length > 1 ? `${this.currentEnemies[0].name}„Åü„Å°` : this.currentEnemies[0].name;
                this.showMessage(`${names}„Åå„ÅÇ„Çâ„Çè„Çå„ÅüÔºÅ`);
                this.updateBattleInfo();
                this.unlockCommands();
                this.playBattleMusic();
            },

            renderParty() {
                // Êà¶ÈóòÁîªÈù¢„Åß„ÅØ‰ª≤Èñì„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÈùûË°®Á§∫„Å´„Åô„Çã
                const partyDisplay = document.getElementById('party-display');
                if (partyDisplay) partyDisplay.remove();
            },

            renderFieldParty() {
                const fieldStatus = document.getElementById('field-party-status');
                if (!fieldStatus) return;

                const segments = [];

                const addControls = (type, index, member) => {
                    const isFront = member.formation !== 'back';
                    const btn = isFront
                        ? `<button style="padding:4px 8px;font-size:12px;" onclick="game.setFormation('${type}', ${index ?? 'null'}, 'back')">ÂæåË°õ„Å´„Åô„Çã</button>`
                        : `<button style="padding:4px 8px;font-size:12px;" onclick="game.setFormation('${type}', ${index ?? 'null'}, 'front')">ÂâçË°õ„Å´„Åô„Çã</button>`;
                    return `<div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap;">${btn}</div>`;
                };

                const memberCardStyle = (member) => {
                    const offset = member.formation === 'back' ? '0' : '-10px';
                    return `padding:5px;border:1px solid #fff;border-radius:3px;position:relative;top:${offset};`;
                };

                const poisonTag = (m) => m.poisoned ? ' <span style="color:#f0f;">ÊØÅE/span>' : '';

                segments.push(`<div style="${memberCardStyle(this.player)}">
                    <strong>${this.player.name}</strong> <span style="font-size:12px;color:#0ff;">${this.player.formation === 'back' ? 'ÂæåË°õ: ' : 'ÂâçË°õ'}</span>${poisonTag(this.player)}<br>
                    ËÅ∑: ${this.player.job}<br>
                    HP: <span style="color:${this.getHpColor(this.player)}">${this.player.hp}</span>/${this.player.maxHp} / MP: ${this.player.mp}/${this.player.maxMp}
                    ${addControls('player', null, this.player)}
                </div>`);

                this.companions
                    .filter(c => c.alive !== false)
                    .forEach(c => {
                        segments.push(`<div style="${memberCardStyle(c)}">
                            <strong>${c.name}</strong> <span style="font-size:12px;color:#0ff;">${c.formation === 'back' ? 'ÂæåË°õ: ' : 'ÂâçË°õ'}</span>${poisonTag(c)}<br>
                            ËÅ∑: ${c.job}<br>
                            HP: <span style="color:${this.getHpColor(c)}">${c.hp}</span>/${c.maxHp} / MP: ${c.mp}/${c.maxMp}
                            ${addControls('companion', this.companions.indexOf(c), c)}
                        </div>`);
                    });

                fieldStatus.innerHTML = segments.join('');
            },

            getNextCompanionName(gender = 'neutral') {
                const pool = gender === 'male' ? this.companionHumanNamesMale :
                              gender === 'female' ? this.companionHumanNamesFemale :
                              this.companionHumanNamesNeutral;
                return pool[Math.floor(Math.random() * pool.length)];
            },

            getRecruitJobForNPC(npc) {
                if (!npc) return this.companionNames[this.companionNameIndex % this.companionNames.length];
                const spriteJobMap = {
                    '‚ú®': 'È≠îÊ≥ï‰Ωø„ÅÑ',
                    'üßÅ': 'Âç†„ÅÑÂ∏´',
                    'üë¥': 'ÂÉß‰æ∂',
                    'üó°': 'Êà¶Â£´',
                    'üõ°': 'È®éÂ£´',
                    'üèπ': 'Áã©‰∫∫',
                    'üíÉ': 'Ë∏ä„ÇäÂ≠ê',
                    'üßë‚Äçüç≥': 'ÊñôÁêÜ‰∫∫',
                    'üßë‚Äçüè≠': 'Ê≠¶ÂÖ∑ËÅ∑‰∫∫'
                };
                if (npc.sprite && spriteJobMap[npc.sprite]) {
                    return spriteJobMap[npc.sprite];
                }
                if (npc.name && npc.name.includes('Âç†')) return 'È≠îÊ≥ï‰Ωø„ÅÑ';
                if (npc.name && npc.name.includes('È≠î')) return 'È≠îÊ≥ï‰Ωø„ÅÑ';
                if (npc.name && npc.name.includes('Ë≥¢')) return 'ÂÉß‰æ∂';
                if (npc.name && npc.name.includes('ÂÉß')) return 'ÂÉß‰æ∂';
                if (npc.name && npc.name.includes('Ê≠¶Âô®')) return 'Ê≠¶ÂÖ∑ËÅ∑‰∫∫';
                if (npc.name && npc.name.includes('Áõó')) return 'ÁõóË≥ä';
                if (npc.name && npc.name.includes('Áã©')) return 'Áã©‰∫∫';
                if (npc.name && npc.name.includes('ÂïÜ‰∫∫')) return 'ÂïÜ‰∫∫';
                if (npc.name && npc.name.includes('È®é')) return 'È®éÂ£´';
                if (npc.name && npc.name.includes('Ë∏ä')) return 'Ë∏ä„ÇäÂ≠ê';
                return 'Êà¶Â£´';
            },

            getNPCGender(npc) {
                if (npc && npc.gender) return npc.gender;
                if (npc && npc.name && (npc.name.includes('Âß´') || npc.name.includes('Â®Å'))) return 'female';
                return 'male';
            },

            getRandomAptitude() {
                return this.aptitudes[Math.floor(Math.random() * this.aptitudes.length)];
            },

            chooseFieldMusicSource() {
                const list = ['„Éï„Ç°„É≥„Çø„Ç∏„Éº-Áï∞Â§â-.mp3','field.mp3','„Éï„Ç°„É≥„Çø„Ç∏„Éº7-Ë°ó-.mp3'];
                return list[Math.floor(Math.random() * list.length)];
            },

            getEnemyTier(enemy) {
                const exp = enemy.exp || 1;
                const superNames = ['„Ç¥„Éº„É¨„É†', '„Ç≠„É©„Éº„Éä„Ç§„Éà', '„Ç™„Éº„Ç¨„É≠„Éº„Éâ', 'Ê£Æ„ÅÆÈ≠îÂ•≥', '„Éñ„É©„ÉÉ„Éá„Ç£„Éä„Ç§„Éà', '„Éü„Çπ„Éà„Éü„Éé„Çø„Ç¶„É≠„Çπ', '„Ç∑„É£„Éâ„Ç¶„Ç≥„Éû„É≥„ÉÄ„Éº'];
                if (superNames.includes(enemy.name)) return 'super';
                if (exp < 15) return 'low';
                if (exp < 30) return 'mid';
                return 'high';
            },

            chooseTierByLevel() {
                let base = 'low';
                if (this.player.level <= 3) {
                    base = 'low';
                } else if (this.player.level <= 6) {
                    base = 'mid';
                } else if (this.player.level <= 12) {
                    base = 'high';
                } else {
                    base = 'high';
                }

                const r = Math.random();
                if (base === 'low') {
                    return r < 0.1 ? 'mid' : 'low';
                } else if (base === 'mid') {
                    if (r < 0.15) return 'low';
                    if (r < 0.30) return 'high';
                    return 'mid';
                } else { // base high
                    if (r < 0.15) return 'mid';
                    if (r < 0.30 && this.player.level >= 13) return 'super';
                    return 'high';
                }
            },

            getCompanionTemplate(job) {
                const templates = {
                    'Êà¶Â£´': { hp: 32, mp: 0, attack: 6, defense: 4, speed: 8 },
                    'È®éÂ£´': { hp: 30, mp: 6, attack: 6, defense: 5, speed: 7 },
                    'È≠îÊ≥ï‰Ωø„ÅÑ': { hp: 18, mp: 14, attack: 2, defense: 2, speed: 10 },
                    'ÂÉß‰æ∂': { hp: 22, mp: 12, attack: 2, defense: 3, speed: 9 },
                    'ÁõóË≥ä': { hp: 24, mp: 0, attack: 4, defense: 3, speed: 12 },
                    'Áã©‰∫∫': { hp: 26, mp: 0, attack: 5, defense: 4, speed: 11 },
                    'Ë∏ä„ÇäÂ≠ê': { hp: 23, mp: 10, attack: 2, defense: 2, speed: 9 },
                    'Ê≠¶ÂÖ∑ËÅ∑‰∫∫': { hp: 26, mp: 0, attack: 2, defense: 2, speed: 6 },
                    'ÂïÜ‰∫∫': { hp: 20, mp: 0, attack: 2, defense: 2, speed: 6 },
                    'ÂêüÈÅäË©©‰∫∫': { hp: 20, mp: 12, attack: 2, defense: 2, speed: 10 }
                };
                return templates[job] || { hp: 22, mp: 8, attack: 4, defense: 3, speed: 9 };
            },

            setFormation(targetType, index, position) {
                if (position !== 'front' && position !== 'back') return;
                let member = null;
                if (targetType === 'player') {
                    member = this.player;
                } else if (targetType === 'companion') {
                    member = this.companions[index];
                }
                if (!member) return;

                const currentIsBack = member.formation === 'back';
                if ((position === 'back' && currentIsBack) || (position === 'front' && !currentIsBack)) return;

                const party = [this.player, ...this.companions.filter(c => c.alive !== false)];
                const futureFront = party.reduce((count, p) => {
                    if (p === member) {
                        return count + (position === 'front' ? 1 : 0);
                    }
                    return count + (p.formation === 'back' ? 0 : 1);
                }, 0);
                if (futureFront <= 0) {
                    this.showMessage('ÂÖ®Âì°ÂæåË°õ„Å´„ÅØ„Åß„Åç„Åæ„Åõ„Çì„ÄÇË™∞„Åã1‰∫∫„ÅØÂâçË°õ„Å´ÊÆã„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }

                member.formation = position;
                const label = position === 'back' ? 'ÂæåË°õ' : 'ÂâçË°õ';
                this.showMessage(`${member.name}„ÅØ${label}„Å´ÈÖçÁΩÆ„Åï„Çå„Åü„ÄÇ`);
                this.renderFieldParty();
                this.renderParty();
            },

            isMagicOrRanged(attacker) {
                if (!attacker) return false;
                if (this.hasRangedWeapon(attacker)) return true;
                const job = attacker.job || '';
                return job.includes('È≠îÊ≥ï‰Ωø„ÅÑ') || job.includes('ÂÉß') || job.includes('Ë≥¢') || job.includes('Áã©‰∫∫') || job.includes('Â∞ÅÂç∞') || job.includes('ÂêüÈÅä');
            },

            meetNPC() {
                const npc = this.npcs[Math.floor(Math.random() * this.npcs.length)];
                const message = npc.messages[Math.floor(Math.random() * npc.messages.length)];
                this.inBattle = true;
                document.getElementById('field-container').style.display = 'none';
                document.getElementById('player').style.display = 'none';
                const bs = document.getElementById('battle-screen');
                bs.classList.remove('force-hide');
                bs.style.display = 'flex';
                document.getElementById('battle-commands').style.display = 'none';
                document.getElementById('enemy-group').innerHTML = `<div style="font-size:80px">${npc.sprite}</div>`;
                
                // ‰ª≤ÈñìÂãßË™òÂà§ÂÆöÔºÅ30%„ÅÆÁ¢∫Áéá
                let buttons = '';
                const nonRecruitables = ['ËÄÅ‰∫∫','Â∞ëÂπ¥','ÂïÜ‰∫∫„ÅÆÂ®ò','Âß´','ÂåªËÄÖ'];
                const canRecruitThisNpc = !nonRecruitables.includes(npc.name);
                if (canRecruitThisNpc && Math.random() < 0.3 && this.companions.length < 10) {
                    const job = this.getRecruitJobForNPC(npc) || 'Êà¶Â£´';
                    const companionObj = { job, name: this.getNextCompanionName(this.getNPCGender(npc)) };
                    const companionJson = encodeURIComponent(JSON.stringify(companionObj));
                    buttons = `
                        <button onclick="game.recruitCompanion(decodeURIComponent('${companionJson}'), '${npc.sprite}')" style="margin-top:10px;padding:10px 20px;margin-right:10px;">‰ª≤Èñì„Å´„Åô„Çã</button>
                        <button onclick="game.leaveNPC()" style="margin-top:10px;padding:10px 20px;">Ë¶ãÈÄÅ„Å£„Å¶„Åä„Åè</button>
                    `;
                } else {
                    buttons = `<button onclick="game.leaveNPC()" style="margin-top:20px;padding:15px 30px;">„Çè„Åã„Å£„Åü</button>`;
                }
                
                document.getElementById('battle-info').innerHTML = `<div style="font-size:18px;margin:20px;">${npc.name}: ${message}</div>${buttons}`;
            },

            recruitCompanion(companionJson, sprite) {
                let companionData;
                try {
                    companionData = typeof companionJson === 'string' ? JSON.parse(companionJson) : companionJson;
                } catch(e) {
                    companionData = { job: '‰ª≤Èñì', name: this.getNextCompanionName() };
                }
                if (!companionData.job) companionData.job = 'Êà¶Â£´';
                    const baseStats = this.getCompanionTemplate(companionData.job);
                    let factor = 0.8 + Math.random() * 0.4; // 0.8 - 1.2
                    // „É¨„Ç¢Á¥†Ë≥™Ë£úÊ≠£
                    const rareRoll = Math.random();
                    if (rareRoll < 0.005) {
                        // ÂÖ®ËÉΩÂäÅE30%‰ª•‰∏ÅE                        
                        factor = 1.3 + Math.random() * 0.2; // 1.3 - 1.5
                    } else if (rareRoll < 0.015) {
                        // „ÅÜ<ÔøΩÔøΩ„Çå„Åã„ÅÆËÉΩÂäÅE40%‰ª•‰∏ÅE                        
                        factor = 0.8 + Math.random() * 0.4;
                        const stat = ['hp','mp','attack','defense','speed'][Math.floor(Math.random() * 5)];
                        baseStats[stat] = Math.round(baseStats[stat] * (1.4 + Math.random() * 0.2)); // 1.4-1.6
                    } else if (rareRoll < 0.065) {
                        // „ÅÜ<ÔøΩÔøΩ„Çå„Åã„ÅÆËÉΩÂäÅE30%‰ª•‰∏ÅE                        
                        const stat = ['hp','mp','attack','defense','speed'][Math.floor(Math.random() * 5)];
                        baseStats[stat] = Math.round(baseStats[stat] * (1.3 + Math.random() * 0.1)); // 1.3-1.4
                    }
                const companion = {
                    name: companionData.name,
                    job: companionData.job,
                    sprite: sprite,
                    hp: Math.round(baseStats.hp * factor),
                    maxHp: Math.round(baseStats.hp * factor),
                    mp: Math.round(baseStats.mp * factor),
                    maxMp: Math.round(baseStats.mp * factor),
                    level: this.player.level,
                    exp: 0,
                    attack: Math.max(1, Math.round(baseStats.attack * factor)),
                    defense: Math.max(0, Math.round(baseStats.defense * factor)),
                    speed: Math.max(1, Math.round(baseStats.speed * factor)),
                    poisoned: false,
                    alive: true,
                    aptitude: this.getRandomAptitude(),
                    formation: 'front',
                    equipment: {
                        weapon: null,
                        armor: null,
                        helmet: null,
                        gloves: null,
                        boots: null
                    },
                    inventory: {}, // ÈÅìÂÖ∑„Åî„Å®„ÅÆÂêÑ„Ç¢„Ç§„ÉÜ„É†„ÅÆÊâÄÊúâÊï∞
                    inventorySlots: 0 // ÁèæÂú®„ÅÆÈÅìÂÖ∑„Çπ„É≠„ÉÉ„Éà‰ΩøÁî®Êï∞
                };
                this.companions.push(companion);
                this.showMessage(`${companion.job} ${companion.name}„Åå‰ª≤Èñì„Å´„Å™„Å£„ÅüÔºÅ`);
                this.updateStatus();
                this.renderFieldParty();
                // ‰ª≤ÈñìËøΩÂä†Âæå„ÇÇbattle-screen„ÇíÂøÅEÔøΩÔøΩÈùûË°®Á§∫„Å´
                const bs = document.getElementById('battle-screen');
                bs.style.display = 'none';
                bs.classList.add('force-hide');
                this.leaveNPC();
            },

            addItemToCompanion(companionIndex, itemName, quantity = 1) {
                const companion = this.companions[companionIndex];
                if (!companion) return false;
                
                // ÁèæÂú®„ÅÆ„Çπ„É≠„ÉÅEÔøΩÔøΩ‰ΩøÁî®Êï∞„Çí„ÉÅ„Çß„ÉÅEÔøΩÔøΩ
                const currentCount = (companion.inventory[itemName] || 0) + quantity;
                const addedSlots = quantity;
                
                // ÊúÄÂ§ß10ÂÄã„Åæ„Åß
                if (companion.inventorySlots + addedSlots > 10) {
                    return false;
                }
                
                companion.inventory[itemName] = currentCount;
                companion.inventorySlots += addedSlots;
                return true;
            },

            removeItemFromCompanion(companionIndex, itemName, quantity = 1) {
                const companion = this.companions[companionIndex];
                if (!companion || !companion.inventory[itemName]) return false;
                
                const current = companion.inventory[itemName];
                if (current < quantity) return false;
                
                companion.inventory[itemName] -= quantity;
                companion.inventorySlots -= quantity;
                
                if (companion.inventory[itemName] === 0) {
                    delete companion.inventory[itemName];
                }
                return true;
            },

            leaveNPC() {
                // NPC„Ç§„Éô„É≥„ÉàÂæåÔøΩEÂç≥Â∫ß„Å´„Éê„Éà„É´ÁµÇ‰∫ÅE                
                // NPCÈñ¢ÈÄ£Ë¶ÅÁ¥†„ÇÇ„ÇØ„É™„Ç¢„ÉªÈùûË°®Á§∫
                document.getElementById('battle-info').innerHTML = '';
                document.getElementById('enemy-group').innerHTML = '';
                const bs = document.getElementById('battle-screen');
                bs.style.display = 'none';
                bs.classList.add('force-hide');
                document.getElementById('battle-commands').style.display = 'none';
                document.getElementById('magic-menu').style.display = 'none';
                document.getElementById('item-menu').style.display = 'none';
                this.endBattle(true);
            },

            renderEnemies() {
                const bs = document.getElementById('battle-screen');
                bs.classList.remove('force-hide');
                bs.style.display = 'flex';
                const group = document.getElementById('enemy-group');
                group.innerHTML = '';
                this.currentEnemies.forEach((enemy, i) => {
                    const container = document.createElement('div');
                    container.className = 'enemy-container';
                    if (enemy.hp <= 0) {
                        container.classList.add('dead');
                        // ÂÄí„Çå„ÅüÊïµ„ÅØ„ÇØ„É™„ÉÉ„ÇØ‰∏çÂèØ
                    } else {
                        if (i === this.selectedEnemyIndex) container.classList.add('selected');
                        container.onclick = () => {
                            this.selectedEnemyIndex = i;
                            this.renderEnemies();
                        };
                    }
                    
                    const sprite = document.createElement('div');
                    sprite.className = 'enemy-sprite';
                    sprite.textContent = enemy.sprite;
                    const number = document.createElement('div');
                    number.className = 'enemy-number';
                    number.textContent = this.currentEnemies.length > 1 ? String.fromCharCode(65 + i) : '';
                    container.appendChild(sprite);
                    container.appendChild(number);
                    group.appendChild(container);
                });
            },

            updateBattleInfo() {
                const alive = this.currentEnemies.filter(e => e.hp > 0);
                let info = alive.map((e, i) => {
                    const idx = this.currentEnemies.indexOf(e);
                    const letter = alive.length > 1 ? String.fromCharCode(65 + idx) + ': ' : '';
                    return letter + e.name;
                }).join('<br>');
                document.getElementById('battle-info').innerHTML = info;
            },

            attack() {
                if (this.commandsLocked) return;
                
                let target = this.currentEnemies[this.selectedEnemyIndex];
                if (!target || target.hp <= 0) {
                    this.selectNextAliveEnemy();
                    target = this.currentEnemies[this.selectedEnemyIndex];
                }
                if (!target || target.hp <= 0) {
                    this.showMessage('ÊîªÊíÉ„Åß„Åç„ÇãÊïµ„Åå„ÅÑ„Åæ„Åõ„Çì');
                    return;
                }
                
                this.lockCommands();
                
                // „É°„ÉÅEÔøΩÔøΩ„Éº„Ç∏„Éú„ÉÉ„ÇØ„Çπ„Çí„ÇØ„É™„Ç¢
                document.getElementById('message-box').innerHTML = '';
                
                this.executeSpeedBasedTurn();
            },

            selectNextAliveEnemy() {
                // ÁèæÂú®ÈÅ∏Êäû‰∏≠„ÅÆÊïµ„ÅåÂÄí„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅÊ¨°„ÅÆÁîü„Åç„Å¶„ÅÑ„ÇãÊïµ„ÇíÈÅ∏Êäû                
                for (let i = 0; i < this.currentEnemies.length; i++) {
                    if (this.currentEnemies[i].hp > 0) {
                        this.selectedEnemyIndex = i;
                        this.renderEnemies();
                        return;
                    }
                }
            },

            openMagicMenu() {
                if (this.commandsLocked) return;
                document.getElementById('battle-commands').style.display = 'none';
                document.getElementById('magic-menu').style.display = 'block';
            },

            closeMagicMenu() {
                document.getElementById('magic-menu').style.display = 'none';
                document.getElementById('battle-commands').style.display = 'grid';
            },

            openItemMenu() {
                if (this.commandsLocked) return;
                const list = document.getElementById('item-list');
                list.innerHTML = '';
                for (let item in this.player.inventory) {
                    if (this.player.inventory[item] > 0) {
                        const div = document.createElement('div');
                        div.className = 'shop-item';
                        div.innerHTML = `${item} √ÅE${this.player.inventory[item]}`;
                        div.onclick = () => this.useItem(item);
                        list.appendChild(div);
                    }
                }
                document.getElementById('battle-commands').style.display = 'none';
                document.getElementById('item-menu').style.display = 'block';
            },

            closeItemMenu() {
                document.getElementById('item-menu').style.display = 'none';
                document.getElementById('battle-commands').style.display = 'grid';
            },

            useItem(item) {
                if (this.player.inventory[item] <= 0) return;
                
                // ÂØæË±°ÈÅ∏Êäû„É°„Éã„É•„Éº„ÇíË°®Á§∫
                this.showItemTargetMenu(item);
            },

            showItemTargetMenu(item) {
                const targets = document.getElementById('target-menu-content');
                targets.innerHTML = `<h3>${item}„ÇíË™∞„Å´‰Ωø„ÅÑ„Åæ„Åô„ÅãÔºü</h3>`;
                
                // „Éó„É¨„Ç§„É§„Éº„ÇíÈÅ∏ÊäûËÇ¢„Å®„Åó„Å¶ËøΩÂä†
                const playerBtn = document.createElement('button');
                playerBtn.className = 'target-button player';
                playerBtn.textContent = `${this.player.name} HP: ${this.player.hp}/${this.player.maxHp}${this.player.poisoned ? 'üíúÊØí' : ''}`;
                playerBtn.onclick = () => this.applyItemEffect(item, this.player, null);
                targets.appendChild(playerBtn);
                
                // ‰ª≤Èñì„ÇíÈÅ∏ÊäûËÇ¢„Å®„Åó„Å¶ËøΩÂä†
                this.aliveCompanions.forEach((companion, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'target-button companion';
                    btn.textContent = `${companion.name} HP: ${companion.hp}/${companion.maxHp}${companion.poisoned ? 'üíúÊØí' : ''}`;
                    btn.onclick = () => this.applyItemEffect(item, companion, index);
                    targets.appendChild(btn);
                });
                
                document.getElementById('item-menu').style.display = 'none';
                document.getElementById('item-target-menu').style.display = 'block';
            },

            closeItemTargetMenu() {
                document.getElementById('item-target-menu').style.display = 'none';
                document.getElementById('item-menu').style.display = 'block';
            },

            applyItemEffect(item, target, companionIndex) {
                if (this.player.inventory[item] <= 0) return;
                if (target && target.alive === false) return;
                
                this.player.inventory[item]--;
                document.getElementById('item-target-menu').style.display = 'none';
                this.closeItemMenu();
                
                let message = '';
                if (item === '„ÇÑ„Åè„Åù„ÅÜ') {
                    const healAmount = 30;
                    target.hp = Math.min(target.maxHp, target.hp + healAmount);
                    message = `${target.name}„Å´„ÇÑ„Åè„Åù„ÅÜ„Çí‰Ωø„Å£„ÅüÔºÅHP„Åå${healAmount}ÂõûÂæ©„Åó„ÅüÔºÅ`;
                } else if (item === '„Å©„Åè„Åë„Åó„Åù„ÅÜ') {
                    target.poisoned = false;
                    message = `${target.name}„Å´„Å©„Åè„Åë„Åó„Åù„ÅÜ„Çí‰Ωø„Å£„ÅüÔºÅ„Å©„Åè„ÅåÊ≤ª„Å£„ÅüÔºÅ`;
                } else if (item === '„Å°„Åã„Çâ„ÅÆ„Åü„Å≠') {
                    target.attack += 1;
                    message = `${target.name}„ÅÆÊîªÊíÉÂäõ„Åå1‰∏ä„Åå„Å£„ÅüÔºÅ`;
                }
                
                this.showMessage(message);
                this.updateStatus();
                this.renderParty();
                
                setTimeout(() => {
                    this.lockCommands();
                    this.executeSpeedBasedTurn();
                }, 300);
            },

            runAway() {
                if (this.commandsLocked) return;
                this.lockCommands();
                if (Math.random() < 0.7) {
                    this.showMessage('„ÅÜ„Åæ„Åè„Å´„Åí„Åç„Å£„ÅüÔºÅ');
                    setTimeout(() => {
                        this.endBattle();
                    }, 1500);
                } else {
                    this.showMessage('„Å´„Åí„Çâ„Çå„Å™„Åã„Å£„ÅüÔºÅ');
                    setTimeout(() => {
                        this.enemiesAttack();
                    }, 1000);
                }
            },

            enemiesAttack() {
                if (!this.inBattle) return;
                const alive = this.currentEnemies.filter(e => e.hp > 0);
                if (alive.length === 0) {
                    this.unlockCommands();
                    return;
                }
                this.lockCommands();
                let idx = 0;
                const attackSeq = () => {
                    if (idx >= alive.length || !this.inBattle) {
                        this.renderEnemies();
                        this.updateBattleInfo();
                        this.showMessage('„ÅÇ„Å™„Åü„ÅÆ„Çø„Éº„É≥„Åß„ÅôÔºÅ');
                        this.unlockCommands();
                        return;
                    }
                    const enemy = alive[idx];
                    this.enemyAct(enemy, () => {
                        idx++;
                        setTimeout(attackSeq, 400);
                    });
                };
                attackSeq();
            },

            getActorSpeed(actor) {
                const base = actor.speed || 10;
                return Math.floor(base * (0.8 + Math.random() * 0.4));
            },

            executeSpeedBasedTurn() {
                const enemiesAlive = this.currentEnemies.filter(e => e.hp > 0);
                if (enemiesAlive.length === 0) {
                    this.winBattle();
                    return;
                }

                const participants = [
                    { type: 'player', ref: this.player },
                    ...this.aliveCompanions.map(c => ({ type: 'companion', ref: c })),
                    ...enemiesAlive.map(e => ({ type: 'enemy', ref: e }))
                ].map(p => ({ ...p, speedRoll: this.getActorSpeed(p.ref) }));

                participants.sort((a, b) => b.speedRoll - a.speedRoll);

                let idx = 0;
                const actNext = () => {
                    if (idx >= participants.length || !this.inBattle) {
                        this.renderEnemies();
                        this.updateBattleInfo();
                        this.unlockCommands();
                        return;
                    }
                    const actor = participants[idx];
                    if (actor.type !== 'enemy') {
                        const poisonResult = this.applyPoisonTick(actor.ref, 'battle');
                        if (poisonResult === 'player_dead') { setTimeout(() => this.gameOver(), 500); return; }
                        if (actor.ref.hp <= 0 || actor.ref.alive === false) {
                            idx++; setTimeout(actNext, 300); return;
                        }
                    }
                    if (actor.type === 'enemy' && actor.ref.hp <= 0) {
                        idx++; setTimeout(actNext, 300); return;
                    }
                    if ((actor.type === 'player' || actor.type === 'companion') && this.currentEnemies.every(e => e.hp <= 0)) {
                        this.winBattle();
                        return;
                    }
                    if (actor.type === 'enemy') {
                        this.enemyAct(actor.ref, () => {
                            idx++; setTimeout(actNext, 400);
                        });
                    } else {
                        this.playerSideAct(actor.ref, actor.type === 'player', () => {
                            idx++; setTimeout(actNext, 400);
                        });
                    }
                };
                actNext();
            },

            pickSpell(caster) {
                const entries = this.getAvailableSpellsForMember(caster);
                const usable = entries.filter(s => s.mp <= caster.mp);
                if (usable.length === 0) return null;

                const injured = this.getInjuredAlly();
                if (injured) {
                    const heal = usable.find(s => s.target === 'ally');
                    if (heal) return heal;
                }
                usable.sort((a, b) => b.mp - a.mp);
                return usable[0];
            },

            getAvailableSpellsForMember(member) {
                const all = Object.entries(this.spells || {}).map(([name, data]) => ({ name, ...data }));
                if (!member || !member.job) return all;
                const level = member.level || 1;
                const job = member.job;
                const allow = [];
                if (job.includes('È≠îÊ≥ï‰Ωø„ÅÑ')) {
                    allow.push('„Éï„Ç°„Ç§„Ç¢');
                    if (level >= 5) allow.push('„Éñ„É™„Ç∂„Éº„Éâ');
                    if (level >= 8) allow.push('„Çπ„É™„Éº„Éó');
                    if (level >= 10) allow.push('„Ç§„Ç™');
                } else if (job.includes('ÂÉß‰æ∂')) {
                    allow.push('„Éí„Éº„É´');
                    if (level >= 5) allow.push('„Éï„Ç°„Ç§„Ç¢');
                }
                if (allow.length === 0) return [];
                return all.filter(s => allow.includes(s.name));
            },

            applyAptitudeGrowth(member, isPlayer = false) {
                if (!member.aptitude) member.aptitude = this.getRandomAptitude();
                // base growth
                let hpUp = isPlayer ? 10 : 8;
                let mpUp = isPlayer ? 5 : 3;
                let atkUp = isPlayer ? 2 : 1;
                let defUp = isPlayer ? 1 : 1;
                let spdUp = isPlayer ? 1 : 1;

                switch (member.aptitude) {
                    case 'Êà¶Â£´„Çø„Ç§„Éó':
                        hpUp += 4;
                        atkUp += 1;
                        break;
                    case 'È≠îÊ≥ï‰Ωø„ÅÑ„Çø„Ç§„Éó':
                        mpUp += 3;
                        break;
                    case 'ÂÉß‰æ∂„Çø„Ç§„Éó':
                        mpUp += 2;
                        hpUp += 1;
                        break;
                    case 'ÁõóË≥ä„Çø„Ç§„Éó':
                        spdUp += 2;
                        defUp = Math.max(0, defUp - 1);
                        break;
                    case 'Áã©‰∫∫„Çø„Ç§„Éó':
                        atkUp += 1;
                        spdUp += 1;
                        break;
                    default:
                        break;
                }

                member.maxHp += hpUp;
                member.hp = member.maxHp;
                member.maxMp += mpUp;
                member.mp = member.maxMp;
                member.attack += atkUp;
                member.defense += defUp;
                member.speed += spdUp;
            },

            getInjuredAlly() {
                const members = [this.player, ...this.aliveCompanions];
                let best = null;
                let minRatio = 1;
                members.forEach(m => {
                    const ratio = m.hp / m.maxHp;
                    if (ratio < 0.7 && ratio < minRatio) {
                        minRatio = ratio;
                        best = m;
                    }
                });
                return best;
            },

            playerSideAct(member, isPlayer, done) {
                let currentTarget = this.currentEnemies[this.selectedEnemyIndex];
                if (!currentTarget || currentTarget.hp <= 0) {
                    this.selectNextAliveEnemy();
                    currentTarget = this.currentEnemies[this.selectedEnemyIndex];
                }
                if (!currentTarget || currentTarget.hp <= 0) {
                    done();
                    return;
                }

                const canCast = !isPlayer && member.job && member.job.includes('È≠îÊ≥ï‰Ωø„ÅÑ') && member.mp > 0;
                const spell = canCast ? this.pickSpell(member) : null;

                if (spell) {
                    member.mp -= spell.mp;
                    this.playSoundEffect('player-attack-se');
                    if (!this.damageHistory[member.name]) this.damageHistory[member.name] = 0;

                    if (spell.target === 'ally') {
                    const targetAlly = this.getInjuredAlly();
                    if (targetAlly) {
                        const heal = spell.power;
                        targetAlly.hp = Math.min(targetAlly.maxHp, targetAlly.hp + heal);
                        this.showMessage(`<span class="msg-ally">${member.name}„ÅØ${spell.name}„Çí„Å®„Å™„Åà„Åü„ÄÇ${targetAlly.name}„ÅÆHP„Åå${heal}ÂõûÂæ©„Åó„Åü„ÄÇ</span>`);
                        this.updateStatus();
                            this.renderParty();
                            done();
                            return;
                        }
                    } else if (spell.target === 'all') {
                        this.currentEnemies.filter(e => e.hp > 0).forEach(e => {
                            let base = spell.power + member.attack - e.defense;
                            if (spell.name === '„Éï„Ç°„Ç§„Ç¢') base += Math.floor(Math.random() * 11) - 5; // ‰π±Êï∞ÂπÅEÔøΩÔøΩÂ§ß
                            const dmg = Math.max(1, base);
                            e.hp = Math.max(0, e.hp - dmg);
                            this.damageHistory[member.name] += dmg;
                        });
                        this.showMessage(`<span class="msg-ally">${member.name}„ÅØ${spell.name}„Çí„Å®„Å™„Åà„Åü„ÄÇÊïµÂÖ®‰Ωì„Å´„ÉÄ„É°„Éº„Ç∏„Çí‰∏é„Åà„Åü„ÄÇ</span>`);
                    } else {
                        let base = spell.power + member.attack - currentTarget.defense;
                        if (spell.name === '„Éï„Ç°„Ç§„Ç¢') base += Math.floor(Math.random() * 11) - 5; // ‰π±Êï∞ÂπÅEÔøΩÔøΩÂ§ß
                        const dmg = Math.max(1, base);
                        currentTarget.hp = Math.max(0, currentTarget.hp - dmg);
                        this.damageHistory[member.name] += dmg;
                        this.showMessage(`<span class="msg-ally">${member.name}„ÅØ${spell.name}„Çí„Å®„Å™„Åà„Åü„ÄÇ${currentTarget.name}„Å´${dmg}„ÅÆ„ÉÄ„É°„Éº„Ç∏„Çí‰∏é„Åà„Åü„ÄÇ</span>`);
                    }

                    this.renderEnemies();
                    this.updateBattleInfo();
                    if (this.checkAllDead()) {
                        setTimeout(() => this.winBattle(), 500);
                        done();
                        return;
                    }
                    done();
                    return;
                }

                const baseAttack = member.attack + this.getMemberEquipmentStat(member, 'attack') + (isPlayer ? 0 : 1);
                let attackPower = baseAttack;
                if (member.formation === 'back' && !this.isMagicOrRanged(member)) {
                    attackPower = Math.max(1, Math.floor(attackPower / 3));
                }
                const rand = isPlayer ? Math.floor(Math.random() * 3) : Math.floor(Math.random() * 2);
                const damage = Math.max(1, attackPower - currentTarget.defense + rand);
                currentTarget.hp = Math.max(0, currentTarget.hp - damage);

                if (!this.damageHistory[member.name]) {
                    this.damageHistory[member.name] = 0;
                }
                    this.damageHistory[member.name] += damage;

                    this.playSoundEffect('player-attack-se');
                    this.showMessage(`<span class="msg-ally">${member.name}„ÅØ${currentTarget.name}„Å´${damage}„ÅÆ„ÉÄ„É°„Éº„Ç∏ÔºÅ</span>`);

                const enemies = document.querySelectorAll('.enemy-container');
                const enemyIndex = this.selectedEnemyIndex;
                if (enemies && enemies.length > enemyIndex) {
                    const enemy = enemies[enemyIndex];
                    enemy.style.animation = 'none';
                    setTimeout(() => {
                        enemy.style.animation = 'enemy-shake 0.4s ease-in-out';
                    }, 10);
                }

                if (this.checkAllDead()) {
                    setTimeout(() => this.winBattle(), 500);
                }
                done();
            },

            enemyAct(enemy, done) {
                const party = [this.player, ...this.aliveCompanions];
                const weightedParty = [];
                party.forEach(member => {
                    const weight = member.formation === 'back' ? 1 : 3;
                    for (let i = 0; i < weight; i++) weightedParty.push(member);
                });
                const target = weightedParty[Math.floor(Math.random() * weightedParty.length)];

                // È≠îÊ≥ïÁ≥ª„Å™„Çâ„Éï„Ç°„Ç§„Ç¢„Çí‰ΩøÁî®ÔøΩEÔøΩEP„Åå„ÅÇ„ÇåÔøΩEÔøΩEÔøΩE                
                const isMage = this.isEnemyMage(enemy);
                if (isMage) {
                    enemy.mp = enemy.mp || 10;
                    if (enemy.mp >= 3) {
                        enemy.mp -= 3;
                        const totalDefense = target.defense + this.getMemberEquipmentStat(target, 'defense');
                        let base = 15 + Math.floor(Math.random() * 11) - 5; // „Éï„Ç°„Ç§„Ç¢‰π±Êï∞ÂπÖÂ§ß
                        base = base + enemy.attack - totalDefense;
                        let damage = Math.max(1, base);
                        if (target.formation === 'back') damage = Math.max(1, Math.ceil(damage / 2));
                        target.hp = Math.max(0, target.hp - damage);
                    this.playSoundEffect('enemy-attack-se');
                    this.shakeScreen();
                    this.updateStatus();
                    this.renderParty();
                    this.showMessage(`<span class="msg-enemy">${enemy.name}„ÅØ„Éï„Ç°„Ç§„Ç¢„Çí„Å®„Å™„Åà„Åü„ÄÇ${target.name}„Å´${damage}„ÅÆ„ÉÄ„É°„Éº„Ç∏„Çí‰∏é„Åà„Åü„ÄÇ</span>`);
                    this.damageTakenMax[target.name] = Math.max(this.damageTakenMax[target.name] || 0, damage);
                    this.updateBattleInfo();
                    if (target === this.player && target.hp <= 0) {
                        setTimeout(() => this.gameOver(), 1500);
                        return;
                    } else if (target !== this.player && target.hp <= 0) {
                        target.alive = false;
                        this.showMessage(`${target.name}„ÅØ„Åü„Åä„Çå„Åü...`);
                        this.aliveCompanions = this.companions.filter(c => c.alive !== false);
                        this.renderParty();
                    }
                    const poisonResult = this.processPoisonAfterHit(target);
                    if (poisonResult === 'player_dead') {
                        setTimeout(() => this.gameOver(), 1500);
                        return;
                    }
                    done();
                    return;
                }
                }

                const totalDefense = target.defense + this.getMemberEquipmentStat(target, 'defense');
                let damage = Math.max(1, enemy.attack - totalDefense + Math.floor(Math.random() * 2));
                if (target.formation === 'back') {
                    damage = Math.max(1, Math.ceil(damage / 2));
                }
                target.hp = Math.max(0, target.hp - damage);
                this.damageTakenMax[target.name] = Math.max(this.damageTakenMax[target.name] || 0, damage);

                this.playSoundEffect('enemy-attack-se');
                this.shakeScreen();
                this.updateStatus();
                this.renderParty();

                let msg = `${enemy.name}„ÅØ${target.name}„Å´${damage}„ÅÆ„ÉÄ„É°„Éº„Ç∏„Çí‰∏é„Åà„ÅüÔºÅ`;
                if (enemy.poison && !target.poisoned && Math.random() < 0.3) {
                    target.poisoned = true;
                    msg += '<br>„Å©„ÅèÁä∂ÊÖã„Å´„Å™„Å£„ÅüÔºÅ';
                }
                    this.showMessage(`<span class="msg-enemy">${msg}</span>`);
                    this.updateBattleInfo();
                    
                const poisonResult = this.processPoisonAfterHit(target);

                if (target === this.player && target.hp <= 0) {
                    setTimeout(() => this.gameOver(), 1500);
                    return;
                } else if (target !== this.player && target.hp <= 0) {
                    target.alive = false;
                    this.showMessage(`${target.name}„ÅØ„Åü„Åä„Çå„Åü...`);
                    this.aliveCompanions = this.companions.filter(c => c.alive !== false);
                    this.renderParty();
                }

                if (poisonResult === 'player_dead') {
                    setTimeout(() => this.gameOver(), 1500);
                    return;
                }

                done();
            },
            processPoisonAfterHit(target) {
                return this.applyPoisonTick(target, 'battle');
            },

            applyPoisonTick(target, context = 'battle') {
                if (!target || !target.poisoned) return false;
                const poisonDamage = Math.floor(Math.random() * 2) + 1;
                target.hp = Math.max(0, target.hp - poisonDamage);
                this.showMessage(`<span class="msg-enemy">${target.name}„ÅØÊØí„Å´„Çà„Çä${poisonDamage}„ÅÆ„ÉÄ„É°„Éº„Ç∏„ÇíÂèó„Åë„ÅüÔºÅ</span>`);
                this.damageTakenMax[target.name] = Math.max(this.damageTakenMax[target.name] || 0, poisonDamage);
                this.updateStatus();
                this.renderParty();
                
                if (target === this.player && target.hp <= 0) {
                    return 'player_dead';
                } else if (target !== this.player && target.hp <= 0) {
                    target.alive = false;
                    this.showMessage(`${target.name}„ÅØ„Åü„Åä„Çå„Åü...`);
                    this.aliveCompanions = this.companions.filter(c => c.alive !== false);
                    this.renderParty();
                    return 'companion_dead';
                }
                return false;
            },

            isEnemyMage(enemy) {
                if (!enemy || !enemy.name) return false;
                return enemy.name.includes('È≠î') || enemy.name.includes('Ë≥¢ËÄÖ') || enemy.name.includes('„É°„Ç§„Ç∏') || enemy.name.includes('„Ç¥„Éº„Çπ„Éà') || enemy.name.includes('„Ç∑„É£„Éâ„Ç¶') || enemy.name.includes('„Ç¶„Ç£„Ç∂„Éº„Éâ');
            },

            checkAllDead() {
                return this.currentEnemies.every(e => e.hp <= 0);
            },

            winBattle() {
                if (this.battleEnded) return;
                this.battleEnded = true;
                let baseExp = 0;
                let totalGold = 0;
                let drops = [];
                
                this.currentEnemies.forEach(enemy => {
                    baseExp += enemy.exp;
                    totalGold += enemy.gold;
                    
                    // „Éâ„É≠„ÉÉ„ÉóÂà§ÂÆö                    
                    if (enemy.drops) {
                        enemy.drops.forEach(drop => {
                            if (Math.random() < drop.chance) {
                                if (drop.item === 'gold') {
                                    totalGold += drop.amount;
                                    drops.push(`${drop.amount}„Ç¥„Éº„É´„Éâ`);
                                } else if (drop.type) {
                                    // Ë£ÅÁ∏´ÂìÅ                                    
                                    this.player.equipment[drop.type] = {
                                        name: drop.item,
                                        attack: drop.attack,
                                        defense: drop.defense
                                    };
                                    drops.push(drop.item);
                                } else {
                                    // „Ç¢„Ç§„ÉÜ„É†
                                    if (!this.player.inventory[drop.item]) {
                                        this.player.inventory[drop.item] = 0;
                                    }
                                    this.player.inventory[drop.item]++;
                                    drops.push(drop.item);
                                }
                            }
                        });
                    }
                });
                
                this.player.gold += totalGold;
                
                // „ÉÄ„É°„Éº„Ç∏Â±•Ê≠¥„Å´Âü∫„Å•„ÅÜÁµåÈ®ìÂÄ§„ÇíÈÖçÂàÜ                
                // „ÉÄ„É°„Éº„Ç∏ÂêàË®à„ÇíË®àÁÆó                
                let totalDamage = 0;
                for (let memberName in this.damageHistory) {
                    totalDamage += this.damageHistory[memberName];
                }
                
                // ÁµåÈ®ìÂÄ§„ÇíÈÖçÂàÜÔºà¬±20%„ÅÆ„Å∞„Çâ„Å§„Åç‰ªò„ÅçÔºâ                
                const expVariation = (Math.random() * 0.4) - 0.2; // ¬±20%
                const actualExp = Math.max(1, Math.floor(baseExp * (1 + expVariation)));
                
                let message = `ÂãùÂà©ÔºÅ<br>ÁµåÈ®ìÂÄ§${actualExp}„Å®${totalGold}„Ç¥„Éº„É´„ÉâÁç≤ÂæóÔºÅ<br>ÁµåÈ®ìÂÄ§ÈÖçÂàÜ: `;
                
                // ÂãÅEÔøΩÔøΩEÔøΩEÁµåÈ®ìÂÄ§Ë®àÁÆó                
                if (totalDamage > 0) {
                    const playerDamage = this.damageHistory[this.player.name] || 0;
                    let playerExpShare = Math.floor(actualExp * (playerDamage / totalDamage));
                    if ((this.damageTakenMax[this.player.name] || 99) <= 1 && playerExpShare > 1) {
                        playerExpShare = 1;
                    }
                    if (playerExpShare > 0) {
                        this.player.exp += playerExpShare;
                        message += `${this.player.name}:${playerExpShare} `;
                    }
                } else {
                    this.player.exp += actualExp;
                    message += `${this.player.name}:${actualExp} `;
                }
                
                // ‰ª≤ÈñìÔøΩEÁµåÈ®ìÂÄ§ÈÖçÔøΩE
                for (let companion of this.aliveCompanions) {
                    if (totalDamage > 0) {
                        const companionDamage = this.damageHistory[companion.name] || 0;
                        let companionExpShare = Math.floor(actualExp * (companionDamage / totalDamage));
                        if ((this.damageTakenMax[companion.name] || 99) <= 1 && companionExpShare > 1) {
                            companionExpShare = 1;
                        }
                        if (companionExpShare > 0) {
                            companion.exp += companionExpShare;
                            message += `${companion.name}:${companionExpShare} `;
                        }
                    } else {
                        companion.exp += actualExp;
                        message += `${companion.name}:${actualExp} `;
                    }
                    this.checkCompanionLevelUp(companion);
                }
                
                if (drops.length > 0) {
                    message += `<br>${drops.join('„ÄÅ')}„ÇíÊâã„Å´ÂÖ•„Çå„ÅüÔºÅ`;
                }
                
                this.showMessage(message);
                this.updateStatus();
                this.renderParty();
                this.checkLevelUp();
                
                // Êïµ„ÇíÂÄí„Åó„ÅüÊôÇ„Å´Êà¶ÈóòÈü≥Ê•Ω„Çí„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà                
                this.fadeOutMusic(1000);
                
                this.endBattle();
            },

            checkCompanionLevelUp(companion) {
                const needed = companion.level * 20;
                if (companion.exp >= needed) {
                    companion.level++;
                    companion.exp = 0;
                    this.applyAptitudeGrowth(companion);
                    this.playSoundEffect('levelup-se');
                    this.showMessage(`${companion.name}„ÅÆ„É¨„Éô„É´„ÅÜ<{companion.level}„Å´„Å™„Å£„ÅüÔºÅ`);
                    this.showMessage(`„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÔºÅ<br>${companion.name}„ÅØ„É¨„Éô„É´${companion.level}„Å´„Å™„Å£„ÅüÔºÅ`);
                    this.renderFieldParty();
                }
            },

            checkLevelUp() {
                const needed = this.player.level * 20;
                if (this.player.exp >= needed) {
                    this.player.level++;
                    this.player.exp = 0;
                    this.applyAptitudeGrowth(this.player, true);
                    this.updateStatus();
                    
                    // Êà¶ÈóòÈü≥Ê•Ω„ÇíÊ≠¢„ÇÅ„Çã
                    const battleMusic = document.getElementById(`battle-music-${this.battleMusicIndex}`);
                    if (battleMusic && this.musicEnabled) {
                        battleMusic.pause();
                        battleMusic.volume = 0.3;
                    }
                    
                    // 1ÁßíÂæÅEÔøΩÔøΩ„Å¶„Åã„Çâ„É¨„Éô„É´„Ç¢„ÉÅEÔøΩEË°®Á§∫
                    setTimeout(() => {
                        // „É¨„Éô„É´„Ç¢„ÉÉ„ÉóÂäπÊûúÈü≥„ÇíÂÜçÁîü                        
                        this.playSoundEffect('levelup-se');
                        this.showMessage(`„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÔºÅ<br>„É¨„Éô„É´${this.player.level}„Å´„Å™„Å£„ÅüÔºÅ`);
                    }, 1000);
                }
            },

            gameOver() {
                if (this.gameOverFlag) return;
                this.gameOverFlag = true;
                this.inBattle = false;
                this.commandsLocked = true;
                this.lockCommands();
                this.stopMusic();
                this.showMessage('„ÅÇ„Å™„Åü„ÅØ„Åó„Çì„Åß„Åó„Åæ„Å£„Åü..<br>„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº');
                const battleScreen = document.getElementById('battle-screen');
                battleScreen.style.display = 'none';
                const field = document.getElementById('field-container');
                const player = document.getElementById('player');
                if (field) field.style.display = 'none';
                if (player) player.style.display = 'none';
                const cmds = document.getElementById('battle-commands');
                if (cmds) cmds.style.display = 'none';
                const overlayId = 'game-over-overlay';
                if (!document.getElementById(overlayId)) {
                    const overlay = document.createElement('div');
                    overlay.id = overlayId;
                    overlay.style.position = 'absolute';
                    overlay.style.top = '0';
                    overlay.style.left = '0';
                    overlay.style.width = '100%';
                    overlay.style.height = '100%';
                    overlay.style.background = 'rgba(0,0,0,0.9)';
                    overlay.style.display = 'flex';
                    overlay.style.flexDirection = 'column';
                    overlay.style.alignItems = 'center';
                    overlay.style.justifyContent = 'center';
                    overlay.style.fontSize = '28px';
                    overlay.style.color = '#f00';
                    overlay.style.zIndex = '2000';
                    overlay.innerHTML = '„ÅÇ„Å™„Åü„ÅØ„Åó„Çì„Åß„Åó„Åæ„Å£„Åü..<br>„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº';
                    const gameScreen = document.getElementById('game-screen');
                    if (gameScreen) gameScreen.appendChild(overlay);
                }
            },

            endBattle(immediate = false) {
                this.battleEnded = true;
                const battleScreen = document.getElementById('battle-screen');
                if (immediate) {
                    this.inBattle = false;
                    this.commandsLocked = false;
                    battleScreen.style.display = 'none';
                    battleScreen.classList.add('force-hide');
                    battleScreen.classList.remove('fade-out');
                    document.getElementById('field-container').style.display = 'block';
                    document.getElementById('player').style.display = 'block';
                    this.unlockCommands();
                    this.showMessage('ÂÜíÈô∫„Çí„Å§„Å•„Åë„Çà„ÅÜÔºÅ');
                    this.playFieldMusic();
                } else {
                    // 2ÁßíÂæÅEÔøΩÔøΩ„Åó„Å¶„Åã„Çâ„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„ÉàÈñãÂßÅE                    
                    setTimeout(() => {
                        // „Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíËøΩÂä†
                        battleScreen.classList.add('fade-out');
                        // 2ÁßíÂæå„Å´ÁîªÈù¢„ÇíÈùûË°®Á§∫„Å´„Åó„Å¶„Éï„Ç£„Éº„É´„Éâ„ÇíË°®Á§∫
                        setTimeout(() => {
                            this.inBattle = false;
                            this.commandsLocked = false;
                            battleScreen.style.display = 'none';
                            battleScreen.classList.remove('fade-out');
                            document.getElementById('field-container').style.display = 'block';
                            document.getElementById('player').style.display = 'block';
                            this.unlockCommands();
                            this.showMessage('ÂÜíÈô∫„Çí„Å§„Å•„Åë„Çà„ÅÜÔºÅ');
                            this.playFieldMusic();
                        }, 1000);
                    }, 1000);
                }
            },

            openShop(shopType) {
                const shop = this.shops[shopType];
                if (!shop) return;
                this.currentShop = shopType;
                const menu = document.getElementById('shop-menu');
                const title = document.getElementById('shop-title');
                const itemsDiv = document.getElementById('shop-items');
                
                title.textContent = shop.name;
                itemsDiv.innerHTML = '';
                
                shop.items.forEach((item, i) => {
                    const div = document.createElement('div');
                    div.className = 'shop-item';
                    const stat = item.attack ? `Êîª+${item.attack}` : `Èò≤+${item.defense}`;
                    div.innerHTML = `<span>${item.name} (${stat})</span><span>${item.price}G</span>`;
                    div.onclick = () => this.buyItem(item);
                    itemsDiv.appendChild(div);
                });
                
                menu.style.display = 'block';
                this.playShopMusic();
            },

            buyItem(item) {
                if (this.player.gold < item.price) {
                    alert('„Åä„Åã„Å≠„Åå„Åü„Çä„Å™„ÅÑ');
                    return;
                }
                this.pendingShopItem = item;
                this.openEquipmentTargetMenu();
            },

            closeShop() {
                document.getElementById('shop-menu').style.display = 'none';
                this.currentShop = null;
                this.inShop = false;
                this.playFieldMusic();
                this.pendingShopItem = null;
            },

            chooseEquipmentTarget() {
                const members = [this.player, ...this.companions.filter(c => c.alive !== false)];
                const list = members.map((m, idx) => `${idx}: ${m.name} (${m.job || '‰ª≤Èñì'})`).join('\n');
                const input = prompt(`Ë™∞„Å´Ë£ÖÂÇô„Åï„Åõ„Åæ„Åô„ÅãÔºüÁï™Âè∑„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:\n${list}`, '0');
                if (input === null) return null;
                const idx = parseInt(input, 10);
                if (isNaN(idx) || idx < 0 || idx >= members.length) {
                    alert('ÂÖ•Âäõ„ÅåÁÑ°Âäπ„Åß„Åô„ÄÇÂãáËÄÖ„Å´Ë£ÖÂÇô„Åï„Åõ„Åæ„Åô„ÄÇ');
                    return this.player;
                }
                return members[idx];
            },

            openInn() {
                document.getElementById('inn-menu').style.display = 'block';
                this.playShopMusic();
            },

            closeInn() {
                document.getElementById('inn-menu').style.display = 'none';
                this.inShop = false;
                this.playFieldMusic();
            },

            stayAtInn() {
                const party = [this.player, ...this.companions];
                const price = this.shops.inn.price * party.length;
                if (this.player.gold >= price) {
                    this.player.gold -= price;
                    party.forEach(m => {
                        if (m.alive === false) return; // ÂÄí„Çå„Åü‰ª≤Èñì„ÅØÂæ©Ê¥ª„Åó„Å™„ÅÑ                        
                        m.hp = m.maxHp;
                        m.mp = m.maxMp;
                        m.poisoned = false;
                    });
                    this.updateStatus();
                    this.renderFieldParty();
                    alert(`„ÇÅ„ÅÑ„Å£„Å±„ÅÑ‰ºë„Çì„Å†„ÄÅ${party.length}‰∫∫„Åß${price}G „Åã„Åã„Å£„Åü„ÄÅHP„Å®MP„ÅåÂÖ®ÂõûÂæ©„Åó„Åü`);
                    this.closeInn();
                } else {
                    alert('„Åä„Åã„Å≠„Åå„Åü„Çä„Å™„ÅÑ');
                }
            },

            openEquipmentMenu() {
                this.renderEquipmentMenu();
                document.getElementById('equipment-menu').style.display = 'block';
            },

            closeEquipmentMenu() {
                document.getElementById('equipment-menu').style.display = 'none';
            },

            renderEquipmentMenu() {
                const list = document.getElementById('equipment-list');
                list.innerHTML = '';

                const members = [this.player, ...this.companions.filter(c => c.alive !== false)];
                const selectorId = 'equipment-member-selector';
                let selector = document.getElementById(selectorId);
                if (!selector) {
                    selector = document.createElement('select');
                    selector.id = selectorId;
                    selector.style.marginBottom = '12px';
                    selector.onchange = (e) => {
                        this.equipmentViewIndex = parseInt(e.target.value, 10) || 0;
                        this.renderEquipmentMenu();
                    };
                    list.parentElement.insertBefore(selector, list);
                }

                selector.innerHTML = members.map((m, idx) => `<option value="${idx}" ${idx === this.equipmentViewIndex ? 'selected' : ''}>${m.name} (${m.job || '‰ª≤Èñì'})</option>`).join('');
                const member = members[this.equipmentViewIndex] || this.player;

                const slots = [
                    { key: 'weapon', label: '„Å∂„ÅÜ„Åê' },
                    { key: 'armor', label: '„Çà„Çç„ÅÑ' },
                    { key: 'helmet', label: '„Åã„Å∂„Å®' },
                    { key: 'gloves', label: '„Å¶„Å∂„Åè„Çç' },
                    { key: 'boots', label: '„Åê„Å§' }
                ];

                slots.forEach(slot => {
                    const div = document.createElement('div');
                    div.className = 'equipment-item';
                    const item = member.equipment ? member.equipment[slot.key] : null;

                    if (item) {
                        const attackStat = item.attack ? ` <span class="equipment-stat">Êîª+${item.attack}</span>` : '';
                        const defenseStat = item.defense ? ` <span class="equipment-stat">Èò≤+${item.defense}</span>` : '';
                        const ranged = item.ranged ? ` <span class="equipment-stat">ÈÅ†+${item.ranged}</span>` : '';
                        div.innerHTML = `<span>${slot.label}: ${item.name}${attackStat}${defenseStat}${ranged}</span>`;
                    } else {
                        div.innerHTML = `<span>${slot.label}: „Å™„Åó</span>`;
                    }

                    const btn = document.createElement('button');
                    btn.textContent = 'Ë£ÖÂÇô„ÇíÂ§âÊõ¥';
                    btn.style.marginLeft = '10px';
                    btn.onclick = () => this.changeEquipmentSlot(this.equipmentViewIndex, slot.key);
                    div.appendChild(btn);

                    list.appendChild(div);
                });

                const totalAttack = member.attack + this.getMemberEquipmentStat(member, 'attack');
                const totalDefense = member.defense + this.getMemberEquipmentStat(member, 'defense');

                const statsDiv = document.createElement('div');
                statsDiv.style.marginTop = '20px';
                statsDiv.style.borderTop = '2px solid #fff';
                statsDiv.style.paddingTop = '20px';
                statsDiv.innerHTML = `<div style="margin-bottom: 10px;">„Åï„ÅÑ„Å†„ÅÑ Êîª${totalAttack} Èò≤${totalDefense}</div>`;
                list.appendChild(statsDiv);
            },

            changeEquipmentSlot(memberIndex, slotKey) {
                const members = [this.player, ...this.companions.filter(c => c.alive !== false)];
                const targetMember = members[memberIndex];
                if (!targetMember) return;

                const pool = [];
                members.forEach((m, idx) => {
                    if (!m.equipment) return;
                    const item = m.equipment[slotKey];
                    if (item) {
                        pool.push({ ownerIndex: idx, item });
                    }
                });
                const options = pool.map((p, i) => `${i}: ${p.item.name}Ôºà${members[p.ownerIndex].name}„ÅåÊâÄÊåÅÔºâ`).join('\n');
                const choice = prompt(`Ë£ÖÂÇô„ÇíÈÅ∏„Çì„ÅßÁßªÂãïË£ÖÂÇô„Åó„Åæ„ÅôÔºÅ${targetMember.name} „ÅÆ ${slotKey}„Çí„ÄÅÁ©∫„Å´„Åó„Åü„ÅÑÂ†¥Âêà„ÅØÁ©∫Ê¨Ñ„ÅßÊ±∫ÂÆö„ÄÅ\n${options}`, '');
                if (choice === null) return;
                if (choice.trim() === '') {
                    if (targetMember.equipment) targetMember.equipment[slotKey] = null;
                    this.renderEquipmentMenu();
                    this.renderFieldParty();
                    return;
                }
                const idx = parseInt(choice, 10);
                if (isNaN(idx) || idx < 0 || idx >= pool.length) {
                    alert('ÂÖ•Âäõ„ÅåÁÑ°Âäπ„Åß„Åô');
                    return;
                }
                const selected = pool[idx];
                members[selected.ownerIndex].equipment[slotKey] = null;
                if (!targetMember.equipment) {
                    targetMember.equipment = { weapon: null, armor: null, helmet: null, gloves: null, boots: null };
                }
                targetMember.equipment[slotKey] = selected.item;
                this.renderEquipmentMenu();
                this.renderFieldParty();
            },

            openEquipmentTargetMenu() {
                const modal = document.getElementById('equipment-target-menu');
                const list = document.getElementById('equipment-target-list');
                list.innerHTML = '';
                const members = [this.player, ...this.companions.filter(c => c.alive !== false)];
                members.forEach((m, idx) => {
                    const btn = document.createElement('button');
                    btn.className = 'target-button';
                    btn.textContent = `${m.name} (${m.job || '‰ª≤Èñì'})`;
                    btn.onclick = () => this.applyShopPurchaseToTarget(idx);
                    list.appendChild(btn);
                });
                modal.style.display = 'block';
            },

            closeEquipmentTargetMenu() {
                const modal = document.getElementById('equipment-target-menu');
                if (modal) modal.style.display = 'none';
                this.pendingShopItem = null;
            },

            applyShopPurchaseToTarget(idx) {
                const members = [this.player, ...this.companions.filter(c => c.alive !== false)];
                const target = members[idx];
                const item = this.pendingShopItem;
                if (!target || !item) return;
                if (this.player.gold < item.price) {
                    alert('„Åä„Åã„Å≠„Åå„Åü„Çä„Å™„ÅÑ');
                    this.closeEquipmentTargetMenu();
                    return;
                }
                this.player.gold -= item.price;
                if (!target.equipment) {
                    target.equipment = { weapon: null, armor: null, helmet: null, gloves: null, boots: null };
                }
                target.equipment[item.type] = item;
                this.updateStatus();
                this.renderFieldParty();
                alert(`${target.name}„ÅÜ<{item.name}„ÇíË£ÅEÔøΩÔøΩ„Åó„ÅüÔøΩEÔøΩ`);
                this.pendingShopItem = null;
                this.closeEquipmentTargetMenu();
            },

            openFieldItemMenu() {
                const list = document.getElementById('field-item-list');
                list.innerHTML = '';
                for (let item in this.player.inventory) {
                    if (this.player.inventory[item] > 0) {
                        const div = document.createElement('div');
                        div.className = 'shop-item';
                        div.innerHTML = `${item} √ÅE${this.player.inventory[item]}`;
                        div.onclick = () => this.useFieldItem(item);
                        list.appendChild(div);
                    }
                }
                document.getElementById('field-item-menu').style.display = 'block';
            },

            closeFieldItemMenu() {
                document.getElementById('field-item-menu').style.display = 'none';
                this.closeFieldItemTargetMenu();
            },

            useFieldItem(item) {
                if (this.player.inventory[item] <= 0) return;
                
                this.showFieldItemTargetMenu(item);
            },

            getTotalEquipmentStat(stat) {
                let total = 0;
                for (let slot in this.player.equipment) {
                    const item = this.player.equipment[slot];
                    if (item && item[stat]) {
                        total += item[stat];
                    }
                }
                return total;
            },

            getMemberEquipmentStat(member, stat) {
                if (!member || !member.equipment) return 0;
                let total = 0;
                for (let slot in member.equipment) {
                    const item = member.equipment[slot];
                    if (item && item[stat]) {
                        total += item[stat];
                    }
                }
                return total;
            },

            hasRangedWeapon(member) {
                if (!member || !member.equipment) return false;
                const w = member.equipment.weapon;
                return !!(w && w.ranged);
            },

            showFieldItemTargetMenu(item) {
                const modal = document.getElementById('field-item-target-menu');
                const list = document.getElementById('field-item-target-list');
                list.innerHTML = '';
                const members = [this.player, ...this.companions.filter(c => c.alive !== false)];
                members.forEach((m, idx) => {
                    const btn = document.createElement('button');
                    btn.className = 'target-button';
                    const poison = m.poisoned ? ' üíúÊØí' : '';
                    btn.textContent = `${m.name} HP:${m.hp}/${m.maxHp} MP:${m.mp}/${m.maxMp}${poison}`;
                    btn.onclick = () => this.applyFieldItemEffect(item, m);
                    list.appendChild(btn);
                });
                modal.style.display = 'block';
            },

            closeFieldItemTargetMenu() {
                const modal = document.getElementById('field-item-target-menu');
                if (modal) modal.style.display = 'none';
            },

            applyFieldItemEffect(item, target) {
                if (!target || this.player.inventory[item] <= 0) return;
                if (target.alive === false) return;
                if (item === '„ÇÑ„Åè„Åù„ÅÜ') {
                    this.player.inventory[item]--;
                    target.hp = Math.min(target.maxHp, target.hp + 30);
                    this.showMessage(`${target.name}„Å´${item}„Çí‰Ωø„Å£„ÅüÔºÅHP„Åå30ÂõûÂæ©„Åó„ÅüÔºÅ`);
                } else if (item === '„Å©„Åè„Åë„Åó„Åù„ÅÜ') {
                    this.player.inventory[item]--;
                    target.poisoned = false;
                    this.showMessage(`${target.name}„Å´${item}„Çí‰Ωø„Å£„ÅüÔºÅ„Å©„ÅèÁä∂ÊÖã„ÅåÊ≤ª„Å£„ÅüÔºÅ`);
                } else if (item === '„Å°„Åã„Çâ„ÅÆ„Åü„Å≠') {
                    this.player.inventory[item]--;
                    const increase = Math.floor(Math.random() * 4) + 1;
                    target.attack += increase;
                    this.showMessage(`${target.name}„Å´${item}„Çí‰Ωø„Å£„ÅüÔºÅÊîªÊíÉ„Åå${increase}‰∏ä„Åå„Å£„ÅüÔºÅ`);
                }
                this.updateStatus();
                this.renderFieldParty();
                this.closeFieldItemTargetMenu();
                this.openFieldItemMenu();
            },

            lockCommands() {
                this.commandsLocked = true;
                document.querySelectorAll('#battle-commands button').forEach(b => b.disabled = true);
            },

            unlockCommands() {
                if (!this.inBattle) return;
                this.commandsLocked = false;
                document.querySelectorAll('#battle-commands button').forEach(b => b.disabled = false);
            },

            showMessage(msg) {
                const messageBox = document.getElementById('message-box');
                if (messageBox.innerHTML === '') {
                    messageBox.innerHTML = msg;
                } else {
                    messageBox.innerHTML += '<br>' + msg;
                }
                messageBox.scrollTop = messageBox.scrollHeight;
            },

            getHpColor(member) {
                if (!member || member.maxHp === 0) return '#fff';
                const ratio = member.hp / member.maxHp;
                if (ratio <= 0.2) return '#f00';
                if (ratio <= 0.5) return '#f90';
                return '#fff';
            },

            updateStatus() {
                document.getElementById('level').textContent = this.player.level;
                document.getElementById('hp').textContent = this.player.hp;
                document.getElementById('maxHp').textContent = this.player.maxHp;
                document.getElementById('mp').textContent = this.player.mp;
                document.getElementById('maxMp').textContent = this.player.maxMp;
                document.getElementById('exp').textContent = this.player.exp;
                document.getElementById('gold').textContent = this.player.gold;
                const jobSpan = document.getElementById('job');
                if (jobSpan) jobSpan.textContent = this.player.job;
                // HP„Ç´„É©„Éº
                const hpSpan = document.getElementById('hp');
                if (hpSpan) {
                    hpSpan.style.color = this.getHpColor(this.player);
                }
                
                // ÊØíÁä∂ÊÖãÔøΩEË°®Á§∫
                const statusDiv = document.getElementById('status');
                let poisonDisplay = statusDiv.querySelector('.poison-status');
                if (this.player.poisoned) {
                    if (!poisonDisplay) {
                        poisonDisplay = document.createElement('div');
                        poisonDisplay.className = 'poison-status';
                        poisonDisplay.style.color = '#f0f';
                        poisonDisplay.style.fontSize = '16px';
                        statusDiv.appendChild(poisonDisplay);
                    }
                    poisonDisplay.textContent = 'üíú ÊØíÁä∂ÊÖã';
                } else if (poisonDisplay) {
                    poisonDisplay.remove();
                }
                
                this.renderFieldParty();
            }
        };

        window.onload = () => game.init();
    </script>
</body>
</html>










